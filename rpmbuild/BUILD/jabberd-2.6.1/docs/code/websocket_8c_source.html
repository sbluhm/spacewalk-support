<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>jabberd2: sx/websocket.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">jabberd2
   &#160;<span id="projectnumber">2.6.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_86f29ab95acaa9cd6ee56e480fbc38c0.html">sx</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">websocket.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="websocket_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> * jabberd - Jabber Open Source Server</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> * Copyright (c) 2015 Tomasz Sterna</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> * This program is free software; you can redistribute it and/or modify</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> * it under the terms of the GNU General Public License as published by</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> * the Free Software Foundation; version 2 of the License.</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * This program is distributed in the hope that it will be useful,</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> * GNU General Public License for more details.</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> * You should have received a copy of the GNU General Public License</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * along with this program; if not, write to the Free Software</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA02111-1307USA</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="sx_8h.html">sx.h</a>&quot;</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &lt;stdarg.h&gt;</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div><div class="line"><a name="l00029"></a><span class="lineno"><a class="line" href="websocket_8c.html#a4575845967f3087a26ffa7f13cbed566">   29</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="websocket_8c.html#a4575845967f3087a26ffa7f13cbed566">websocket_guid</a>[] = <span class="stringliteral">&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span>;</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div><div class="line"><a name="l00031"></a><span class="lineno"><a class="line" href="websocket_8c.html#a1dec008fbb156669ec30f7f5f5d10d5c">   31</a></span>&#160;<span class="keyword">static</span> http_parser_settings <a class="code" href="websocket_8c.html#a1dec008fbb156669ec30f7f5f5d10d5c">settings</a>;</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">/* parts of github.com/payden src/websock.c by Payden Sutherland follow */</span></div><div class="line"><a name="l00034"></a><span class="lineno"><a class="line" href="websocket_8c.html#aed370c3a802dfb53f81fc0bfbc2c5641">   34</a></span>&#160;<span class="preprocessor">#define MASK_LENGTH 4</span></div><div class="line"><a name="l00035"></a><span class="lineno"><a class="line" href="websocket_8c.html#aa09f60de81444ec03fbdc5d01648165e">   35</a></span>&#160;<span class="preprocessor">#define FRAME_CHUNK_LENGTH 1024</span></div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div><div class="line"><a name="l00037"></a><span class="lineno"><a class="line" href="websocket_8c.html#a786da3147cef7625cd87f66b3732e13d">   37</a></span>&#160;<span class="preprocessor">#define WS_OPCODE_CONTINUE 0x0</span></div><div class="line"><a name="l00038"></a><span class="lineno"><a class="line" href="websocket_8c.html#ab79cf9ef93b2acb36d9c1f7eba78bf9e">   38</a></span>&#160;<span class="preprocessor">#define WS_OPCODE_TEXT 0x1</span></div><div class="line"><a name="l00039"></a><span class="lineno"><a class="line" href="websocket_8c.html#ac86b8ed05e11791168295fc48dc1db89">   39</a></span>&#160;<span class="preprocessor">#define WS_OPCODE_BINARY 0x2</span></div><div class="line"><a name="l00040"></a><span class="lineno"><a class="line" href="websocket_8c.html#a153f2c6408b34142e2056dbf7e1fc7e0">   40</a></span>&#160;<span class="preprocessor">#define WS_OPCODE_CLOSE 0x8</span></div><div class="line"><a name="l00041"></a><span class="lineno"><a class="line" href="websocket_8c.html#a2bb01dad9861d977f2516e67adbdff44">   41</a></span>&#160;<span class="preprocessor">#define WS_OPCODE_PING 0x9</span></div><div class="line"><a name="l00042"></a><span class="lineno"><a class="line" href="websocket_8c.html#a617813e5ad89d5c85f9876bdfeb63bc2">   42</a></span>&#160;<span class="preprocessor">#define WS_OPCODE_PONG 0xa</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div><div class="line"><a name="l00044"></a><span class="lineno"><a class="line" href="websocket_8c.html#aa4009f6fda907aeaecaaf64ac791b335">   44</a></span>&#160;<span class="preprocessor">#define WS_FRAGMENT_FIN (1 &lt;&lt; 7)</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div><div class="line"><a name="l00046"></a><span class="lineno"><a class="line" href="websocket_8c.html#a62348e89671e29e78749942417b760cb">   46</a></span>&#160;<span class="preprocessor">#define WS_CLOSE_NORMAL 1000</span></div><div class="line"><a name="l00047"></a><span class="lineno"><a class="line" href="websocket_8c.html#a91457114f2d0f7ebe7b2f72d9509f756">   47</a></span>&#160;<span class="preprocessor">#define WS_CLOSE_GOING_AWAY 1001</span></div><div class="line"><a name="l00048"></a><span class="lineno"><a class="line" href="websocket_8c.html#a8649f79165247f72f96226af4a5e6248">   48</a></span>&#160;<span class="preprocessor">#define WS_CLOSE_PROTOCOL_ERROR 1002</span></div><div class="line"><a name="l00049"></a><span class="lineno"><a class="line" href="websocket_8c.html#a0213273f80981c48f5ca89fbfa10dab9">   49</a></span>&#160;<span class="preprocessor">#define WS_CLOSE_NOT_ALLOWED 1003</span></div><div class="line"><a name="l00050"></a><span class="lineno"><a class="line" href="websocket_8c.html#a146229a5a93c94c5575f8c0eec218202">   50</a></span>&#160;<span class="preprocessor">#define WS_CLOSE_RESERVED 1004</span></div><div class="line"><a name="l00051"></a><span class="lineno"><a class="line" href="websocket_8c.html#a96d6b8aef8e32476ef732cbddcfadb05">   51</a></span>&#160;<span class="preprocessor">#define WS_CLOSE_NO_CODE 1005</span></div><div class="line"><a name="l00052"></a><span class="lineno"><a class="line" href="websocket_8c.html#a1372b01bbbd0fe1b1167b821e71b5f11">   52</a></span>&#160;<span class="preprocessor">#define WS_CLOSE_DIRTY 1006</span></div><div class="line"><a name="l00053"></a><span class="lineno"><a class="line" href="websocket_8c.html#a08044f056f874e3f9c9c8b31e680b5ed">   53</a></span>&#160;<span class="preprocessor">#define WS_CLOSE_WRONG_TYPE 1007</span></div><div class="line"><a name="l00054"></a><span class="lineno"><a class="line" href="websocket_8c.html#a6622168227c705f2085b4eea4b2faa8b">   54</a></span>&#160;<span class="preprocessor">#define WS_CLOSE_POLICY_VIOLATION 1008</span></div><div class="line"><a name="l00055"></a><span class="lineno"><a class="line" href="websocket_8c.html#a1885712c2a9518bf87103c07b0a03130">   55</a></span>&#160;<span class="preprocessor">#define WS_CLOSE_MESSAGE_TOO_BIG 1009</span></div><div class="line"><a name="l00056"></a><span class="lineno"><a class="line" href="websocket_8c.html#a707985d669a9f6de6738796e6171711d">   56</a></span>&#160;<span class="preprocessor">#define WS_CLOSE_UNEXPECTED_ERROR 1011</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno"><a class="line" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161">   58</a></span>&#160;<span class="keyword">enum</span> <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161">WS_FRAME_STATE</a> {</div><div class="line"><a name="l00059"></a><span class="lineno"><a class="line" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161aa1c3517af307dad09ef38748a0b7a0bd">   59</a></span>&#160;        <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161aa1c3517af307dad09ef38748a0b7a0bd">sw_start</a> = 0,</div><div class="line"><a name="l00060"></a><span class="lineno"><a class="line" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161ace503a9e705f438452f71bc827b85f7b">   60</a></span>&#160;        <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161ace503a9e705f438452f71bc827b85f7b">sw_got_two</a>,</div><div class="line"><a name="l00061"></a><span class="lineno"><a class="line" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161a5a9b32213a7f87f70f25e92d1c37e585">   61</a></span>&#160;        <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161a5a9b32213a7f87f70f25e92d1c37e585">sw_got_short_len</a>,</div><div class="line"><a name="l00062"></a><span class="lineno"><a class="line" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161a317cb3780146cb13b900d0c527f059dd">   62</a></span>&#160;        <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161a317cb3780146cb13b900d0c527f059dd">sw_got_full_len</a>,</div><div class="line"><a name="l00063"></a><span class="lineno"><a class="line" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161a1de5a2cbe3da7ae5869e4cfde15500b1">   63</a></span>&#160;        <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161a1de5a2cbe3da7ae5869e4cfde15500b1">sw_loaded_mask</a></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;};</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div><div class="line"><a name="l00066"></a><span class="lineno"><a class="line" href="struct__libwebsock__frame.html">   66</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__libwebsock__frame.html">_libwebsock_frame</a> {</div><div class="line"><a name="l00067"></a><span class="lineno"><a class="line" href="struct__libwebsock__frame.html#a4fdefcd48485e29baeb96c130ced4ad0">   67</a></span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="struct__libwebsock__frame.html#a4fdefcd48485e29baeb96c130ced4ad0">fin</a>;</div><div class="line"><a name="l00068"></a><span class="lineno"><a class="line" href="struct__libwebsock__frame.html#a7c9b9f8be44f48eb518df18449ab9230">   68</a></span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="struct__libwebsock__frame.html#a7c9b9f8be44f48eb518df18449ab9230">opcode</a>;</div><div class="line"><a name="l00069"></a><span class="lineno"><a class="line" href="struct__libwebsock__frame.html#af261f97a025a579bbfc7763b80ac34ac">   69</a></span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="struct__libwebsock__frame.html#af261f97a025a579bbfc7763b80ac34ac">mask_offset</a>;</div><div class="line"><a name="l00070"></a><span class="lineno"><a class="line" href="struct__libwebsock__frame.html#aa9f2fbda1084ffe2865530dbd276e423">   70</a></span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="struct__libwebsock__frame.html#aa9f2fbda1084ffe2865530dbd276e423">payload_offset</a>;</div><div class="line"><a name="l00071"></a><span class="lineno"><a class="line" href="struct__libwebsock__frame.html#a930396080253aad12478fa97c91a9a38">   71</a></span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="struct__libwebsock__frame.html#a930396080253aad12478fa97c91a9a38">rawdata_idx</a>;</div><div class="line"><a name="l00072"></a><span class="lineno"><a class="line" href="struct__libwebsock__frame.html#ab4a2db10d34e1bb1c5d527d41707c15e">   72</a></span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="struct__libwebsock__frame.html#ab4a2db10d34e1bb1c5d527d41707c15e">rawdata_sz</a>;</div><div class="line"><a name="l00073"></a><span class="lineno"><a class="line" href="struct__libwebsock__frame.html#a6f851cc81f0dca146bd01138bd21c79b">   73</a></span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="struct__libwebsock__frame.html#a6f851cc81f0dca146bd01138bd21c79b">size</a>;</div><div class="line"><a name="l00074"></a><span class="lineno"><a class="line" href="struct__libwebsock__frame.html#a8b21f5b9f52ff71b90fd7820d824ece5">   74</a></span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="struct__libwebsock__frame.html#a8b21f5b9f52ff71b90fd7820d824ece5">payload_len_short</a>;</div><div class="line"><a name="l00075"></a><span class="lineno"><a class="line" href="struct__libwebsock__frame.html#a110aa0f18e71d8432a5e0d30c9966429">   75</a></span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="struct__libwebsock__frame.html#a110aa0f18e71d8432a5e0d30c9966429">payload_len</a>;</div><div class="line"><a name="l00076"></a><span class="lineno"><a class="line" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">   76</a></span>&#160;        <span class="keywordtype">char</span> *<a class="code" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">rawdata</a>;</div><div class="line"><a name="l00077"></a><span class="lineno"><a class="line" href="struct__libwebsock__frame.html#a42efff1f67cb6fa8d75b711d5c8a54f9">   77</a></span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="struct__libwebsock__frame.html#a42efff1f67cb6fa8d75b711d5c8a54f9">mask</a>[4];</div><div class="line"><a name="l00078"></a><span class="lineno"><a class="line" href="struct__libwebsock__frame.html#a3c93412d517a8e7f693dc824099c80f9">   78</a></span>&#160;        <span class="keyword">enum</span> <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161">WS_FRAME_STATE</a> <a class="code" href="struct__libwebsock__frame.html#a3c93412d517a8e7f693dc824099c80f9">state</a>;</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;} <a class="code" href="websocket_8c.html#af04d3f2e84f54f8e97aeeba5c4e5974c">libwebsock_frame</a>;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div><div class="line"><a name="l00081"></a><span class="lineno"><a class="line" href="websocket_8c.html#a43b02c8cbb7c3c2873dfab19f5fdca63">   81</a></span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="websocket_8c.html#a43b02c8cbb7c3c2873dfab19f5fdca63">libwebsock_read_header</a>(<a class="code" href="struct__libwebsock__frame.html">libwebsock_frame</a> *frame) {</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <span class="keywordtype">int</span> i, new_size;</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="keyword">enum</span> <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161">WS_FRAME_STATE</a> <a class="code" href="struct__libwebsock__frame.html#a3c93412d517a8e7f693dc824099c80f9">state</a>;</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    state = frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a3c93412d517a8e7f693dc824099c80f9">state</a>;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <span class="keywordflow">switch</span> (state) {</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161aa1c3517af307dad09ef38748a0b7a0bd">sw_start</a>:</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a930396080253aad12478fa97c91a9a38">rawdata_idx</a> &lt; 2) {</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        }</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a3c93412d517a8e7f693dc824099c80f9">state</a> = <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161ace503a9e705f438452f71bc827b85f7b">sw_got_two</a>;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161ace503a9e705f438452f71bc827b85f7b">sw_got_two</a>:</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;        frame-&gt;<a class="code" href="struct__libwebsock__frame.html#af261f97a025a579bbfc7763b80ac34ac">mask_offset</a> = 2;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;        frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a4fdefcd48485e29baeb96c130ced4ad0">fin</a> = (*(frame-&gt;<a class="code" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">rawdata</a>) &amp; 0x80) == 0x80 ? 1 : 0;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a7c9b9f8be44f48eb518df18449ab9230">opcode</a> = *(frame-&gt;<a class="code" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">rawdata</a>) &amp; 0xf;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a8b21f5b9f52ff71b90fd7820d824ece5">payload_len_short</a> = *(frame-&gt;<a class="code" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">rawdata</a> + 1) &amp; 0x7f;</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;        frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a3c93412d517a8e7f693dc824099c80f9">state</a> = <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161a5a9b32213a7f87f70f25e92d1c37e585">sw_got_short_len</a>;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161a5a9b32213a7f87f70f25e92d1c37e585">sw_got_short_len</a>:</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        <span class="keywordflow">switch</span> (frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a8b21f5b9f52ff71b90fd7820d824ece5">payload_len_short</a>) {</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;        <span class="keywordflow">case</span> 126:</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;            <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a930396080253aad12478fa97c91a9a38">rawdata_idx</a> &lt; 4) {</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;            }</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;            frame-&gt;<a class="code" href="struct__libwebsock__frame.html#af261f97a025a579bbfc7763b80ac34ac">mask_offset</a> += 2;</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;            frame-&gt;<a class="code" href="struct__libwebsock__frame.html#aa9f2fbda1084ffe2865530dbd276e423">payload_offset</a> = frame-&gt;<a class="code" href="struct__libwebsock__frame.html#af261f97a025a579bbfc7763b80ac34ac">mask_offset</a> + <a class="code" href="websocket_8c.html#aed370c3a802dfb53f81fc0bfbc2c5641">MASK_LENGTH</a>;</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;            frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a110aa0f18e71d8432a5e0d30c9966429">payload_len</a> = ntohs(</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;                    *((<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> *) (frame-&gt;<a class="code" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">rawdata</a> + 2)));</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;            frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a3c93412d517a8e7f693dc824099c80f9">state</a> = <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161a317cb3780146cb13b900d0c527f059dd">sw_got_full_len</a>;</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        <span class="keywordflow">case</span> 127:</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;            <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a930396080253aad12478fa97c91a9a38">rawdata_idx</a> &lt; 10) {</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;            }</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;            frame-&gt;<a class="code" href="struct__libwebsock__frame.html#af261f97a025a579bbfc7763b80ac34ac">mask_offset</a> += 8;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;            frame-&gt;<a class="code" href="struct__libwebsock__frame.html#aa9f2fbda1084ffe2865530dbd276e423">payload_offset</a> = frame-&gt;<a class="code" href="struct__libwebsock__frame.html#af261f97a025a579bbfc7763b80ac34ac">mask_offset</a> + <a class="code" href="websocket_8c.html#aed370c3a802dfb53f81fc0bfbc2c5641">MASK_LENGTH</a>;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;            frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a110aa0f18e71d8432a5e0d30c9966429">payload_len</a> = ntohl(*((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *) (frame-&gt;<a class="code" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">rawdata</a> + 6)));</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;            frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a3c93412d517a8e7f693dc824099c80f9">state</a> = <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161a317cb3780146cb13b900d0c527f059dd">sw_got_full_len</a>;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;            frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a110aa0f18e71d8432a5e0d30c9966429">payload_len</a> = frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a8b21f5b9f52ff71b90fd7820d824ece5">payload_len_short</a>;</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;            frame-&gt;<a class="code" href="struct__libwebsock__frame.html#aa9f2fbda1084ffe2865530dbd276e423">payload_offset</a> = frame-&gt;<a class="code" href="struct__libwebsock__frame.html#af261f97a025a579bbfc7763b80ac34ac">mask_offset</a> + <a class="code" href="websocket_8c.html#aed370c3a802dfb53f81fc0bfbc2c5641">MASK_LENGTH</a>;</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;            frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a3c93412d517a8e7f693dc824099c80f9">state</a> = <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161a317cb3780146cb13b900d0c527f059dd">sw_got_full_len</a>;</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        }</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161a317cb3780146cb13b900d0c527f059dd">sw_got_full_len</a>:</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a930396080253aad12478fa97c91a9a38">rawdata_idx</a> &lt; frame-&gt;<a class="code" href="struct__libwebsock__frame.html#aa9f2fbda1084ffe2865530dbd276e423">payload_offset</a>) {</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        }</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="websocket_8c.html#aed370c3a802dfb53f81fc0bfbc2c5641">MASK_LENGTH</a>; i++) {</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;            frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a42efff1f67cb6fa8d75b711d5c8a54f9">mask</a>[i] = *(frame-&gt;<a class="code" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">rawdata</a> + frame-&gt;<a class="code" href="struct__libwebsock__frame.html#af261f97a025a579bbfc7763b80ac34ac">mask_offset</a> + i) &amp; 0xff;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        }</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a3c93412d517a8e7f693dc824099c80f9">state</a> = <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161a1de5a2cbe3da7ae5869e4cfde15500b1">sw_loaded_mask</a>;</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a6f851cc81f0dca146bd01138bd21c79b">size</a> = frame-&gt;<a class="code" href="struct__libwebsock__frame.html#aa9f2fbda1084ffe2865530dbd276e423">payload_offset</a> + frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a110aa0f18e71d8432a5e0d30c9966429">payload_len</a>;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a6f851cc81f0dca146bd01138bd21c79b">size</a> &gt; frame-&gt;<a class="code" href="struct__libwebsock__frame.html#ab4a2db10d34e1bb1c5d527d41707c15e">rawdata_sz</a>) {</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;            new_size = frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a6f851cc81f0dca146bd01138bd21c79b">size</a>;</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;            new_size--;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;            new_size |= new_size &gt;&gt; 1;</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;            new_size |= new_size &gt;&gt; 2;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;            new_size |= new_size &gt;&gt; 4;</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;            new_size |= new_size &gt;&gt; 8;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;            new_size |= new_size &gt;&gt; 16;</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;            new_size++;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;            frame-&gt;<a class="code" href="struct__libwebsock__frame.html#ab4a2db10d34e1bb1c5d527d41707c15e">rawdata_sz</a> = new_size;</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;            frame-&gt;<a class="code" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">rawdata</a> = (<span class="keywordtype">char</span> *) realloc(frame-&gt;<a class="code" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">rawdata</a>, new_size);</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        }</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161a1de5a2cbe3da7ae5869e4cfde15500b1">sw_loaded_mask</a>:</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    }</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;}</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div><div class="line"><a name="l00153"></a><span class="lineno"><a class="line" href="websocket_8c.html#a5cce428dfb6e3ca7fdc97008f3abfc92">  153</a></span>&#160;<a class="code" href="struct__sx__buf__st.html">sx_buf_t</a> <a class="code" href="websocket_8c.html#a5cce428dfb6e3ca7fdc97008f3abfc92">libwebsock_fragment_buffer</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> len, <span class="keywordtype">int</span> flags) {</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *payload_len_32_be;</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> *payload_len_short_be;</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> finNopcode, payload_len_small;</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="struct__libwebsock__frame.html#aa9f2fbda1084ffe2865530dbd276e423">payload_offset</a> = 2;</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> frame_size;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    <span class="keywordtype">char</span> *frame;</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    finNopcode = flags &amp; 0xff;</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    <span class="keywordflow">if</span> (len &lt;= 125) {</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        frame_size = 2 + len;</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        payload_len_small = len &amp; 0xff;</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &gt; 125 &amp;&amp; len &lt;= 0xffff) {</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        frame_size = 4 + len;</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        payload_len_small = 126;</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        payload_offset += 2;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &gt; 0xffff &amp;&amp; len &lt;= 0xfffffff0) {</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        frame_size = 10 + len;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        payload_len_small = 127;</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        payload_offset += 8;</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>,</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                <span class="stringliteral">&quot;libwebsock does not support frame payload sizes over %u bytes long\n&quot;</span>,</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                0xfffffff0);</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        <span class="keywordflow">return</span> NULL;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    }</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    <a class="code" href="struct__sx__buf__st.html">sx_buf_t</a> buf = <a class="code" href="sx_8c.html#ae9fe86d2c7082e26fc310f7dc69a1a59">_sx_buffer_new</a>(NULL, frame_size, NULL, NULL);</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    frame = buf-&gt;<a class="code" href="struct__sx__buf__st.html#a0395b2c36d1383766094d53d8f620081">data</a>;</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    payload_len_small &amp;= 0x7f;</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    *frame = finNopcode;</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    *(frame + 1) = payload_len_small;</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <span class="keywordflow">if</span> (payload_len_small == 126) {</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        len &amp;= 0xffff;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        payload_len_short_be = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *) ((<span class="keywordtype">char</span> *) frame + 2);</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        *payload_len_short_be = htons(len);</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    }</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    <span class="keywordflow">if</span> (payload_len_small == 127) {</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        payload_len_32_be = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *) ((<span class="keywordtype">char</span> *) frame + 2);</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        *payload_len_32_be++ = 0;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        *payload_len_32_be = htonl(len);</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    }</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    memcpy(frame + payload_offset, data, len);</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="keywordflow">return</span> buf;</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;}</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="keywordtype">int</span> <a class="code" href="websocket_8c.html#a5bcdeba671c576ff4f031a49e00a5fee">libwebsock_close_with_reason</a>(<a class="code" href="struct__sx__st.html">sx_t</a> s, _sx_websocket_conn_t sc, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> code, <span class="keyword">const</span> <span class="keywordtype">char</span> *reason);</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div><div class="line"><a name="l00201"></a><span class="lineno"><a class="line" href="websocket_8c.html#a8bc922773b09612cb9e922be3a7ea458">  201</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="websocket_8c.html#a8bc922773b09612cb9e922be3a7ea458">libwebsock_send_fragment</a>(<a class="code" href="struct__sx__st.html">sx_t</a> s, _sx_websocket_conn_t sc, <span class="keyword">const</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> len, <span class="keywordtype">int</span> flags) {</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    <a class="code" href="struct__sx__buf__st.html">sx_buf_t</a> buf = <a class="code" href="websocket_8c.html#a5cce428dfb6e3ca7fdc97008f3abfc92">libwebsock_fragment_buffer</a>(data, len, flags);</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    <span class="keywordflow">if</span> (buf == NULL) {</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="websocket_8c.html#a5bcdeba671c576ff4f031a49e00a5fee">libwebsock_close_with_reason</a>(s, sc, <a class="code" href="websocket_8c.html#a707985d669a9f6de6738796e6171711d">WS_CLOSE_UNEXPECTED_ERROR</a>, <span class="stringliteral">&quot;Internal server error&quot;</span>);</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    }</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    <a class="code" href="jqueue_8c.html#af4a242120a03da61e6e2129c16cd7d9e">jqueue_push</a>(s-&gt;<a class="code" href="struct__sx__st.html#ae33e27d3193a61b3d41142ad69d0fe28">wbufq</a>, buf, 0);</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    s-&gt;<a class="code" href="struct__sx__st.html#a4c61463373b07d1ca88a42c14a5ab7d4">want_write</a> = 1;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="sx_8h.html#ae0dede2d3e2457a3ab07c0d5ae7fb3eb">_sx_event</a>(s, <a class="code" href="sx_8h.html#af93b50cc804e6f178556f4d13e5cf136a1be8958474e3b1468f1b772ee1e230bb">event_WANT_WRITE</a>, NULL);</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;}</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;</div><div class="line"><a name="l00211"></a><span class="lineno"><a class="line" href="websocket_8c.html#a5bcdeba671c576ff4f031a49e00a5fee">  211</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="websocket_8c.html#a5bcdeba671c576ff4f031a49e00a5fee">libwebsock_close_with_reason</a>(<a class="code" href="struct__sx__st.html">sx_t</a> s, _sx_websocket_conn_t sc, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> code, <span class="keyword">const</span> <span class="keywordtype">char</span> *reason)</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;{</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> len;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> code_be;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="keywordtype">char</span> buf[128]; <span class="comment">//w3 spec on WebSockets API (http://dev.w3.org/html5/websockets/) says reason shouldn&#39;t be over 123 bytes.  I concur.</span></div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    len = 2;</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    code_be = htobe16(code);</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    memcpy(buf, &amp;code_be, 2);</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="keywordflow">if</span> (reason) {</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        len += snprintf(buf + 2, 124, <span class="stringliteral">&quot;%s&quot;</span>, reason);</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    }</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    sc-&gt;state = websocket_CLOSING;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="keywordtype">int</span> ret = <a class="code" href="websocket_8c.html#a8bc922773b09612cb9e922be3a7ea458">libwebsock_send_fragment</a>(s, sc, buf, len, <a class="code" href="websocket_8c.html#aa4009f6fda907aeaecaaf64ac791b335">WS_FRAGMENT_FIN</a> | <a class="code" href="websocket_8c.html#a153f2c6408b34142e2056dbf7e1fc7e0">WS_OPCODE_CLOSE</a>);</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <a class="code" href="io_8c.html#af7cab32176ea2dd80efad4a47ac2463c">sx_close</a>(s);</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="keywordflow">return</span> ret;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;}</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div><div class="line"><a name="l00230"></a><span class="lineno"><a class="line" href="websocket_8c.html#a8a1eca64e868e62160a625250c61398d">  230</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="websocket_8c.html#a8a1eca64e868e62160a625250c61398d">libwebsock_close</a>(<a class="code" href="struct__sx__st.html">sx_t</a> s, _sx_websocket_conn_t sc)</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;{</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="websocket_8c.html#a5bcdeba671c576ff4f031a49e00a5fee">libwebsock_close_with_reason</a>(s, sc, <a class="code" href="websocket_8c.html#a62348e89671e29e78749942417b760cb">WS_CLOSE_NORMAL</a>, NULL);</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;}</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div><div class="line"><a name="l00235"></a><span class="lineno"><a class="line" href="websocket_8c.html#a56b46814d738f7ec55e13eee4d333038">  235</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="websocket_8c.html#a56b46814d738f7ec55e13eee4d333038">libwebsock_fail_connection</a>(<a class="code" href="struct__sx__st.html">sx_t</a> s, _sx_websocket_conn_t sc, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> close_code) {</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="keywordtype">char</span> close_frame[4] = { 0x88, 0x02, 0x00, 0x00 };</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *code_be = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *) &amp;close_frame[2];</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    *code_be = htobe16(<a class="code" href="websocket_8c.html#a8649f79165247f72f96226af4a5e6248">WS_CLOSE_PROTOCOL_ERROR</a>);</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    <a class="code" href="struct__sx__buf__st.html">sx_buf_t</a> buf = <a class="code" href="sx_8c.html#ae9fe86d2c7082e26fc310f7dc69a1a59">_sx_buffer_new</a>(NULL, <span class="keyword">sizeof</span>(close_frame), NULL, NULL);</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    memcpy(buf-&gt;<a class="code" href="struct__sx__buf__st.html#a0395b2c36d1383766094d53d8f620081">data</a>, close_frame, buf-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a>);</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    sc-&gt;state = websocket_CLOSING;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    s-&gt;<a class="code" href="struct__sx__st.html#a4c61463373b07d1ca88a42c14a5ab7d4">want_write</a> = 1;</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    <a class="code" href="sx_8h.html#ae0dede2d3e2457a3ab07c0d5ae7fb3eb">_sx_event</a>(s, <a class="code" href="sx_8h.html#af93b50cc804e6f178556f4d13e5cf136a1be8958474e3b1468f1b772ee1e230bb">event_WANT_WRITE</a>, NULL);</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <a class="code" href="io_8c.html#af7cab32176ea2dd80efad4a47ac2463c">sx_close</a>(s);</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;}</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div><div class="line"><a name="l00250"></a><span class="lineno"><a class="line" href="websocket_8c.html#ab9beee0107e574d60e84cec1fcf41517">  250</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="websocket_8c.html#ab9beee0107e574d60e84cec1fcf41517">_sx_websocket_http_header_field</a>(http_parser *parser, <span class="keyword">const</span> <span class="keywordtype">char</span> *chars, <span class="keywordtype">size_t</span> length) {</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;HTTP header field &#39;%.*s&#39;&quot;</span>, length, chars);</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    _sx_websocket_conn_t sc = (_sx_websocket_conn_t) parser-&gt;data;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    <span class="keywordflow">if</span>(sc-&gt;header_value) {</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        <span class="comment">// new field incoming</span></div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        <a class="code" href="xhash_8c.html#a77c7505e6946724017451e82203b4b10">xhash_put</a>(sc-&gt;headers,</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                  <a class="code" href="str_8c.html#a8af3044d47157eae581b8e4d994a0946">strunescape</a>(sc-&gt;p, <a class="code" href="str_8c.html#a2b04e422b6cb464e160569c2d242058b">spool_print</a>(sc-&gt;field)),</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                  <a class="code" href="str_8c.html#a8af3044d47157eae581b8e4d994a0946">strunescape</a>(sc-&gt;p, <a class="code" href="str_8c.html#a2b04e422b6cb464e160569c2d242058b">spool_print</a>(sc-&gt;value)));</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        sc-&gt;header_value = 0;</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        sc-&gt;field = <a class="code" href="str_8c.html#a94f1e902c3eb359c45c6f99809579ed3">spool_new</a>(sc-&gt;p);</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    }</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    <a class="code" href="str_8c.html#aaef2515949ac1b1ba24d28c3c5f059c4">spool_escape</a>(sc-&gt;field, chars, length);</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;}</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div><div class="line"><a name="l00265"></a><span class="lineno"><a class="line" href="websocket_8c.html#ac796e1b92b41697bb0c837e1f9586d23">  265</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="websocket_8c.html#ac796e1b92b41697bb0c837e1f9586d23">_sx_websocket_http_header_value</a>(http_parser *parser, <span class="keyword">const</span> <span class="keywordtype">char</span> *chars, <span class="keywordtype">size_t</span> length) {</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;HTTP header value &#39;%.*s&#39;&quot;</span>, length, chars);</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    _sx_websocket_conn_t sc = (_sx_websocket_conn_t) parser-&gt;data;</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    <span class="keywordflow">if</span>(!sc-&gt;header_value) {</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        <span class="comment">// field name complete</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        sc-&gt;header_value = 1;</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;        sc-&gt;value = <a class="code" href="str_8c.html#a94f1e902c3eb359c45c6f99809579ed3">spool_new</a>(sc-&gt;p);</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    }</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    <a class="code" href="str_8c.html#aaef2515949ac1b1ba24d28c3c5f059c4">spool_escape</a>(sc-&gt;value, chars, length);</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;}</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;</div><div class="line"><a name="l00277"></a><span class="lineno"><a class="line" href="websocket_8c.html#a42d3f18934e56d2090af02b32814747e">  277</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="websocket_8c.html#a42d3f18934e56d2090af02b32814747e">_sx_websocket_http_headers_complete</a>(http_parser *parser) {</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    _sx_websocket_conn_t sc = (_sx_websocket_conn_t) parser-&gt;data;</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;HTTP headers complete: %d %s HTTP/%d.%d&quot;</span>, parser-&gt;status_code, http_method_str(parser-&gt;method), parser-&gt;http_major, parser-&gt;http_minor);</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    <span class="keywordflow">if</span> (sc-&gt;header_value) {</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        <span class="comment">/* pull last value by switching to field parser */</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;        <a class="code" href="websocket_8c.html#ab9beee0107e574d60e84cec1fcf41517">_sx_websocket_http_header_field</a>(parser, <span class="stringliteral">&quot;&quot;</span>, 0);</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    }</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;}</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;</div><div class="line"><a name="l00287"></a><span class="lineno"><a class="line" href="websocket_8c.html#aa6f1b74319178f567b26e741dcc92bb7">  287</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="websocket_8c.html#aa6f1b74319178f567b26e741dcc92bb7">_sx_websocket_http_return</a>(<a class="code" href="struct__sx__st.html">sx_t</a> s, <span class="keywordtype">char</span> *status, <span class="keywordtype">char</span> *headers_format, ...) {</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <span class="keywordtype">char</span>* http =</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;        <span class="stringliteral">&quot;HTTP/1.1 %s\r\n&quot;</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        <span class="stringliteral">&quot;%s&quot;</span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        <span class="stringliteral">&quot;Server: &quot;</span> PACKAGE_STRING <span class="stringliteral">&quot;\r\n&quot;</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        <span class="stringliteral">&quot;Expires: Fri, 10 Oct 1997 10:10:10 GMT\r\n&quot;</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        <span class="stringliteral">&quot;Pragma: no-cache\r\n&quot;</span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        <span class="stringliteral">&quot;Cache-control: private\r\n&quot;</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        <span class="stringliteral">&quot;\r\n&quot;</span>;</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    <span class="comment">/* build additional headers */</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    <span class="keywordtype">char</span> headers[1024];</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    va_list args;</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    va_start(args, headers_format);</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    vsnprintf(headers, <span class="keyword">sizeof</span>(headers), headers_format, args);</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    va_end(args);</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    <span class="comment">/* build HTTP answer */</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    <a class="code" href="struct__sx__buf__st.html">sx_buf_t</a> buf = <a class="code" href="sx_8c.html#ae9fe86d2c7082e26fc310f7dc69a1a59">_sx_buffer_new</a>(NULL, <a class="code" href="str_8c.html#afcf3496e637edcfe44e88b517fe18333">j_strlen</a>(http) + <a class="code" href="str_8c.html#afcf3496e637edcfe44e88b517fe18333">j_strlen</a>(status) + <a class="code" href="str_8c.html#afcf3496e637edcfe44e88b517fe18333">j_strlen</a>(headers), NULL, NULL);</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    buf-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a> = sprintf(buf-&gt;<a class="code" href="struct__sx__buf__st.html#a0395b2c36d1383766094d53d8f620081">data</a>, http, status, headers);</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    <a class="code" href="jqueue_8c.html#af4a242120a03da61e6e2129c16cd7d9e">jqueue_push</a>(s-&gt;<a class="code" href="struct__sx__st.html#ae33e27d3193a61b3d41142ad69d0fe28">wbufq</a>, buf, 0);</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    <span class="comment">/* stuff to write */</span></div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    s-&gt;<a class="code" href="struct__sx__st.html#a4c61463373b07d1ca88a42c14a5ab7d4">want_write</a> = 1;</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    <a class="code" href="sx_8h.html#ae0dede2d3e2457a3ab07c0d5ae7fb3eb">_sx_event</a>(s, <a class="code" href="sx_8h.html#af93b50cc804e6f178556f4d13e5cf136a1be8958474e3b1468f1b772ee1e230bb">event_WANT_WRITE</a>, NULL);</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;}</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;</div><div class="line"><a name="l00314"></a><span class="lineno"><a class="line" href="websocket_8c.html#a66ae916ea92382085ee2010ae5ec0264">  314</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="websocket_8c.html#a66ae916ea92382085ee2010ae5ec0264">_sx_websocket_rio</a>(<a class="code" href="struct__sx__st.html">sx_t</a> s, <a class="code" href="struct__sx__plugin__st.html">sx_plugin_t</a> p, <a class="code" href="struct__sx__buf__st.html">sx_buf_t</a> buf) {</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    _sx_websocket_conn_t sc = (_sx_websocket_conn_t) s-&gt;<a class="code" href="struct__sx__st.html#ad08e34d697fd8325ca4cf2c053e6fc83">plugin_data</a>[p-&gt;<a class="code" href="struct__sx__plugin__st.html#abb13fd9b23bee64219e9fb3d0997d669">index</a>];</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    <span class="keywordtype">int</span> i, j, ret, err;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    <span class="keywordtype">char</span> *newbuf;</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    <a class="code" href="structsha1__state__s.html">sha1_state_t</a> sha1;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> hash[20];</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    <span class="comment">/* if not wrapped yet */</span></div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    <span class="keywordflow">if</span>(!(s-&gt;<a class="code" href="struct__sx__st.html#ae36f40642e962113484a05e1b5f9526c">flags</a> &amp; <a class="code" href="plugins_8h.html#a8a4d8720060b21fd5e622ed3f86bd682">SX_WEBSOCKET_WRAPPER</a>)) {</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        <span class="comment">/* look for HTTP handshake */</span></div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        <span class="keywordflow">if</span>(s-&gt;<a class="code" href="struct__sx__st.html#a62f156e716275786904b1cbb1cb9f924">state</a> == <a class="code" href="sx_8h.html#a8c3a879f7829619d857e579100833159aa8bc955fbaeecdd64b56a50c93ead924">state_NONE</a> &amp;&amp; sc-&gt;state == websocket_PRE &amp;&amp; buf-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a> &gt;= 5 &amp;&amp; strncmp(<span class="stringliteral">&quot;GET /&quot;</span>, buf-&gt;<a class="code" href="struct__sx__buf__st.html#a0395b2c36d1383766094d53d8f620081">data</a>, 5) == 0) {</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;            <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;got HTTP handshake&quot;</span>);</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;            sc-&gt;state = websocket_HEADERS;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;        }</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;        <span class="comment">/* pass buffers through http_parser */</span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;        <span class="keywordflow">if</span>(s-&gt;<a class="code" href="struct__sx__st.html#a62f156e716275786904b1cbb1cb9f924">state</a> == <a class="code" href="sx_8h.html#a8c3a879f7829619d857e579100833159aa8bc955fbaeecdd64b56a50c93ead924">state_NONE</a> &amp;&amp; sc-&gt;state == websocket_HEADERS) {</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;            <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;parsing HTTP headers&quot;</span>);</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;            <span class="keywordflow">if</span>(buf-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a> &gt; 0) {</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;loading %d bytes into http_parser %.*s&quot;</span>, buf-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a>, buf-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a>, buf-&gt;<a class="code" href="struct__sx__buf__st.html#a0395b2c36d1383766094d53d8f620081">data</a>);</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;                ret = http_parser_execute(&amp;sc-&gt;parser, &amp;<a class="code" href="websocket_8c.html#a1dec008fbb156669ec30f7f5f5d10d5c">settings</a>, buf-&gt;<a class="code" href="struct__sx__buf__st.html#a0395b2c36d1383766094d53d8f620081">data</a>, buf-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a>);</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;                <span class="keywordflow">if</span> (sc-&gt;parser.upgrade) {</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                    <span class="comment">/* check for required websocket upgrade headers */</span></div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                    <span class="keywordtype">char</span> *upgrade = <a class="code" href="xhash_8c.html#aae269253cc83fcee6883f6097dcb714f">xhash_get</a>(sc-&gt;headers, <span class="stringliteral">&quot;Upgrade&quot;</span>);</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                    <span class="keywordtype">char</span> *connection = <a class="code" href="xhash_8c.html#aae269253cc83fcee6883f6097dcb714f">xhash_get</a>(sc-&gt;headers, <span class="stringliteral">&quot;Connection&quot;</span>);</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                    <span class="keywordtype">char</span> *key = <a class="code" href="xhash_8c.html#aae269253cc83fcee6883f6097dcb714f">xhash_get</a>(sc-&gt;headers, <span class="stringliteral">&quot;Sec-WebSocket-Key&quot;</span>);</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                    <span class="keywordtype">char</span> *proto = <a class="code" href="xhash_8c.html#aae269253cc83fcee6883f6097dcb714f">xhash_get</a>(sc-&gt;headers, <span class="stringliteral">&quot;Sec-WebSocket-Protocol&quot;</span>);</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                    <span class="keywordtype">int</span> version = <a class="code" href="str_8c.html#a80e7fd3fffcd8855c1e971fd6b16fbb2">j_atoi</a>(<a class="code" href="xhash_8c.html#aae269253cc83fcee6883f6097dcb714f">xhash_get</a>(sc-&gt;headers, <span class="stringliteral">&quot;Sec-WebSocket-Version&quot;</span>), -1);</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;                    <span class="keywordflow">if</span>(<a class="code" href="str_8c.html#a4e885bef2a6c68e02ba64bf56b608117">j_strcmp</a>(upgrade, <span class="stringliteral">&quot;websocket&quot;</span>) || connection == NULL || strcasestr(connection, <span class="stringliteral">&quot;Upgrade&quot;</span>) == NULL || <a class="code" href="str_8c.html#a4e885bef2a6c68e02ba64bf56b608117">j_strcmp</a>(proto, <span class="stringliteral">&quot;xmpp&quot;</span>) || version != 13) {</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;                        <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;Upgrade: %s&quot;</span>, upgrade);</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                        <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;Connection: %s&quot;</span>, connection);</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;                        <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;Sec-WebSocket-Key: %s&quot;</span>, key);</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                        <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;Sec-WebSocket-Protocol: %s&quot;</span>, proto);</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                        <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;Sec-WebSocket-Version: %d&quot;</span>, version);</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;                        <a class="code" href="websocket_8c.html#aa6f1b74319178f567b26e741dcc92bb7">_sx_websocket_http_return</a>(s, <span class="stringliteral">&quot;400 Bad Request&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;                        <a class="code" href="io_8c.html#af7cab32176ea2dd80efad4a47ac2463c">sx_close</a>(s);</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                        <span class="keywordflow">return</span> -2;</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                    }</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;                    <span class="comment">/* we&#39;re good to go */</span></div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;                    <a class="code" href="sha1_8c.html#a0ecb75749f90d409425966b4b67bdd02">sha1_init</a>(&amp;sha1);</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;                    <a class="code" href="sha1_8c.html#aad1a273b8ec785f76966a28700fe275e">sha1_append</a>(&amp;sha1, key, <a class="code" href="str_8c.html#afcf3496e637edcfe44e88b517fe18333">j_strlen</a>(key));</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;                    <a class="code" href="sha1_8c.html#aad1a273b8ec785f76966a28700fe275e">sha1_append</a>(&amp;sha1, <a class="code" href="websocket_8c.html#a4575845967f3087a26ffa7f13cbed566">websocket_guid</a>, <span class="keyword">sizeof</span>(<a class="code" href="websocket_8c.html#a4575845967f3087a26ffa7f13cbed566">websocket_guid</a>) -1);</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                    <a class="code" href="sha1_8c.html#a03ed5cd4c7e08af365b30f07947c2ef9">sha1_finish</a>(&amp;sha1, hash);</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                    <span class="keywordtype">char</span> * accept = <a class="code" href="base64_8c.html#ab6f49f5e1242e04e09c0c99bf069c8f9">b64_encode</a>(hash, <span class="keyword">sizeof</span>(hash));</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                    <span class="comment">/* switch protocols */</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                    <a class="code" href="websocket_8c.html#aa6f1b74319178f567b26e741dcc92bb7">_sx_websocket_http_return</a>(s, <span class="stringliteral">&quot;101 Switching Protocols&quot;</span>,</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                                              <span class="stringliteral">&quot;Upgrade: websocket\r\n&quot;</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                                              <span class="stringliteral">&quot;Connection: Upgrade\r\n&quot;</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                                              <span class="stringliteral">&quot;Sec-WebSocket-Accept: %s\r\n&quot;</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                                              <span class="stringliteral">&quot;Sec-WebSocket-Protocol: xmpp\r\n&quot;</span>,</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                                              accept);</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                    free(accept);</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;                    <span class="comment">/* and move past headers */</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                    sc-&gt;state = websocket_ACTIVE;</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                    s-&gt;<a class="code" href="struct__sx__st.html#ae36f40642e962113484a05e1b5f9526c">flags</a> |= <a class="code" href="plugins_8h.html#a8a4d8720060b21fd5e622ed3f86bd682">SX_WEBSOCKET_WRAPPER</a>;</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ret != buf-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a>) {</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                    <span class="comment">/* throw an error */</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                    <a class="code" href="error_8c.html#a2c3a7964ac068e37fc03d3a8dd5ccc19">sx_error</a>(s, <a class="code" href="sx_8h.html#a1df8a93376eda4886470ed664d64ecb5">stream_err_BAD_FORMAT</a>, http_errno_description(sc-&gt;parser.http_errno));</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                    <a class="code" href="io_8c.html#af7cab32176ea2dd80efad4a47ac2463c">sx_close</a>(s);</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                    <span class="keywordflow">return</span> -2;</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;<a class="code" href="struct__sx__plugin__st.html#ac60896df809170de2ec96633239a5cbe">private</a>) {</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                    <span class="keywordtype">char</span> *http_forward = p-&gt;<a class="code" href="struct__sx__plugin__st.html#ac60896df809170de2ec96633239a5cbe">private</a>;</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;                    <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;bouncing HTTP request to %s&quot;</span>, http_forward);</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                    <a class="code" href="websocket_8c.html#aa6f1b74319178f567b26e741dcc92bb7">_sx_websocket_http_return</a>(s, <span class="stringliteral">&quot;301 Found&quot;</span>, <span class="stringliteral">&quot;Location: %s\r\nConnection: close\r\n&quot;</span>, http_forward);</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;                    <a class="code" href="io_8c.html#af7cab32176ea2dd80efad4a47ac2463c">sx_close</a>(s);</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;                    <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;                }</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;unhandling HTTP request&quot;</span>);</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;                <a class="code" href="websocket_8c.html#aa6f1b74319178f567b26e741dcc92bb7">_sx_websocket_http_return</a>(s, <span class="stringliteral">&quot;403 Forbidden&quot;</span>, <span class="stringliteral">&quot;Connection: close\r\n&quot;</span>);</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                <a class="code" href="io_8c.html#af7cab32176ea2dd80efad4a47ac2463c">sx_close</a>(s);</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;                <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;            }</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;            <a class="code" href="sx_8c.html#a2c0702ef72f2dc3adac15b7000499666">_sx_buffer_clear</a>(buf);</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;            <span class="comment">/* flag we want to read */</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;            s-&gt;<a class="code" href="struct__sx__st.html#a646289b98b1c4fa392a25bacbba8b7f6">want_read</a> = 1;</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;        }</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    }</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    <span class="comment">/* only bothering if it is active websocket */</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <span class="keywordflow">if</span>(!(s-&gt;<a class="code" href="struct__sx__st.html#ae36f40642e962113484a05e1b5f9526c">flags</a> &amp; <a class="code" href="plugins_8h.html#a8a4d8720060b21fd5e622ed3f86bd682">SX_WEBSOCKET_WRAPPER</a>) || sc-&gt;state != websocket_ACTIVE)</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;Unwraping WebSocket frame: %d bytes&quot;</span>, buf-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a>);</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <span class="keywordtype">char</span> *data = buf-&gt;<a class="code" href="struct__sx__buf__st.html#a0395b2c36d1383766094d53d8f620081">data</a>;</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; buf-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a>;) {</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        <a class="code" href="struct__libwebsock__frame.html">libwebsock_frame</a> *frame;</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        <span class="keywordflow">if</span> (sc-&gt;frame == NULL) {</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;            frame = (<a class="code" href="struct__libwebsock__frame.html">libwebsock_frame</a> *) calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="struct__libwebsock__frame.html">libwebsock_frame</a>));</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;            frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a110aa0f18e71d8432a5e0d30c9966429">payload_len</a> = -1;</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;            frame-&gt;<a class="code" href="struct__libwebsock__frame.html#ab4a2db10d34e1bb1c5d527d41707c15e">rawdata_sz</a> = <a class="code" href="websocket_8c.html#aa09f60de81444ec03fbdc5d01648165e">FRAME_CHUNK_LENGTH</a>;</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;            frame-&gt;<a class="code" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">rawdata</a> = (<span class="keywordtype">char</span> *) malloc(<a class="code" href="websocket_8c.html#aa09f60de81444ec03fbdc5d01648165e">FRAME_CHUNK_LENGTH</a>);</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;            sc-&gt;frame = frame;</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            frame = sc-&gt;frame;</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        }</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        *(frame-&gt;<a class="code" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">rawdata</a> + frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a930396080253aad12478fa97c91a9a38">rawdata_idx</a>++) = *data++;</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        i++;</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a3c93412d517a8e7f693dc824099c80f9">state</a> != <a class="code" href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161a1de5a2cbe3da7ae5869e4cfde15500b1">sw_loaded_mask</a>) {</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;            err = <a class="code" href="websocket_8c.html#a43b02c8cbb7c3c2873dfab19f5fdca63">libwebsock_read_header</a>(frame);</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;            <span class="keywordflow">if</span> (err == -1) {</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                <span class="keywordflow">if</span> (sc-&gt;state != websocket_CLOSING) {</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                    <a class="code" href="websocket_8c.html#a56b46814d738f7ec55e13eee4d333038">libwebsock_fail_connection</a>(s, sc, <a class="code" href="websocket_8c.html#a8649f79165247f72f96226af4a5e6248">WS_CLOSE_PROTOCOL_ERROR</a>);</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                }</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                <span class="keywordflow">return</span> -2;</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;            }</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;            <span class="keywordflow">if</span> (err == 0) {</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;            }</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        }</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;        <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a930396080253aad12478fa97c91a9a38">rawdata_idx</a> &lt; frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a6f851cc81f0dca146bd01138bd21c79b">size</a>) {</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;            <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a> - i &gt;= frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a6f851cc81f0dca146bd01138bd21c79b">size</a> - frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a930396080253aad12478fa97c91a9a38">rawdata_idx</a>) {</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;                <span class="comment">//remaining in current vector completes frame.  Copy remaining frame size</span></div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;                memcpy(frame-&gt;<a class="code" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">rawdata</a> + frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a930396080253aad12478fa97c91a9a38">rawdata_idx</a>, data,</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                       frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a6f851cc81f0dca146bd01138bd21c79b">size</a> - frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a930396080253aad12478fa97c91a9a38">rawdata_idx</a>);</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;                data += frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a6f851cc81f0dca146bd01138bd21c79b">size</a> - frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a930396080253aad12478fa97c91a9a38">rawdata_idx</a>;</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                i += frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a6f851cc81f0dca146bd01138bd21c79b">size</a> - frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a930396080253aad12478fa97c91a9a38">rawdata_idx</a>;</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a930396080253aad12478fa97c91a9a38">rawdata_idx</a> = frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a6f851cc81f0dca146bd01138bd21c79b">size</a>;</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;                <span class="comment">//not complete frame, copy the rest of this vector into frame.</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;                memcpy(frame-&gt;<a class="code" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">rawdata</a> + frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a930396080253aad12478fa97c91a9a38">rawdata_idx</a>, data, buf-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a> - i);</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;                frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a930396080253aad12478fa97c91a9a38">rawdata_idx</a> += buf-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a> - i;</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;                i = buf-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a>;</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;                <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;more frame data to come&quot;</span>);</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;            }</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;        }</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;        <span class="comment">//have full frame at this point</span></div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;        <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;FIN: %d&quot;</span>, frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a4fdefcd48485e29baeb96c130ced4ad0">fin</a>);</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;        <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;Opcode: %x&quot;</span>, frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a7c9b9f8be44f48eb518df18449ab9230">opcode</a>);</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;        <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;mask_offset: %d&quot;</span>, frame-&gt;<a class="code" href="struct__libwebsock__frame.html#af261f97a025a579bbfc7763b80ac34ac">mask_offset</a>);</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;        <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;payload_offset: %d&quot;</span>, frame-&gt;<a class="code" href="struct__libwebsock__frame.html#aa9f2fbda1084ffe2865530dbd276e423">payload_offset</a>);</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;        <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;rawdata_idx: %d&quot;</span>, frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a930396080253aad12478fa97c91a9a38">rawdata_idx</a>);</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;        <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;rawdata_sz: %d&quot;</span>, frame-&gt;<a class="code" href="struct__libwebsock__frame.html#ab4a2db10d34e1bb1c5d527d41707c15e">rawdata_sz</a>);</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;        <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;payload_len: %u&quot;</span>, frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a110aa0f18e71d8432a5e0d30c9966429">payload_len</a>);</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;        <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a7c9b9f8be44f48eb518df18449ab9230">opcode</a> != <a class="code" href="websocket_8c.html#a786da3147cef7625cd87f66b3732e13d">WS_OPCODE_CONTINUE</a>) {</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;            sc-&gt;opcode = frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a7c9b9f8be44f48eb518df18449ab9230">opcode</a>;</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;        }</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;        <span class="keywordflow">switch</span> (sc-&gt;opcode) {</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="websocket_8c.html#ab79cf9ef93b2acb36d9c1f7eba78bf9e">WS_OPCODE_TEXT</a>:</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;            <span class="comment">/* unmask content */</span></div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;            <span class="keywordflow">for</span> (j = 0; j &lt; frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a110aa0f18e71d8432a5e0d30c9966429">payload_len</a>; j++)</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                frame-&gt;<a class="code" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">rawdata</a>[frame-&gt;<a class="code" href="struct__libwebsock__frame.html#aa9f2fbda1084ffe2865530dbd276e423">payload_offset</a> + j] ^= frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a42efff1f67cb6fa8d75b711d5c8a54f9">mask</a>[j % 4];</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;            <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;payload: %.*s&quot;</span>, frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a110aa0f18e71d8432a5e0d30c9966429">payload_len</a>, frame-&gt;<a class="code" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">rawdata</a> + frame-&gt;<a class="code" href="struct__libwebsock__frame.html#aa9f2fbda1084ffe2865530dbd276e423">payload_offset</a>);</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;            sc-&gt;buf = realloc(sc-&gt;buf, sc-&gt;buf_len + frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a110aa0f18e71d8432a5e0d30c9966429">payload_len</a>);</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;            newbuf = sc-&gt;buf + sc-&gt;buf_len;</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;            strncpy(newbuf, frame-&gt;<a class="code" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">rawdata</a> + frame-&gt;<a class="code" href="struct__libwebsock__frame.html#aa9f2fbda1084ffe2865530dbd276e423">payload_offset</a>, frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a110aa0f18e71d8432a5e0d30c9966429">payload_len</a>);</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;            sc-&gt;buf_len += frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a110aa0f18e71d8432a5e0d30c9966429">payload_len</a>;</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;            <span class="comment">/* hack unclose &lt;open ... /&gt; */</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;            <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a110aa0f18e71d8432a5e0d30c9966429">payload_len</a> &gt;= 7 &amp;&amp; strncmp(newbuf, <span class="stringliteral">&quot;&lt;open&quot;</span>, 5) == 0 &amp;&amp; strncmp(newbuf + frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a110aa0f18e71d8432a5e0d30c9966429">payload_len</a> - 2, <span class="stringliteral">&quot;/&gt;&quot;</span>, 2) == 0) {</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                sc-&gt;buf_len--;</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                sc-&gt;buf[sc-&gt;buf_len - 1] = <span class="charliteral">&#39;&gt;&#39;</span>;</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;            }</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="websocket_8c.html#a153f2c6408b34142e2056dbf7e1fc7e0">WS_OPCODE_CLOSE</a>:</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;            <a class="code" href="websocket_8c.html#a8a1eca64e868e62160a625250c61398d">libwebsock_close</a>(s, sc);</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="websocket_8c.html#a2bb01dad9861d977f2516e67adbdff44">WS_OPCODE_PING</a>:</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;            <a class="code" href="websocket_8c.html#a8bc922773b09612cb9e922be3a7ea458">libwebsock_send_fragment</a>(s, sc, frame-&gt;<a class="code" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">rawdata</a> + frame-&gt;<a class="code" href="struct__libwebsock__frame.html#aa9f2fbda1084ffe2865530dbd276e423">payload_offset</a>, frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a110aa0f18e71d8432a5e0d30c9966429">payload_len</a>, <a class="code" href="websocket_8c.html#aa4009f6fda907aeaecaaf64ac791b335">WS_FRAGMENT_FIN</a> | <a class="code" href="websocket_8c.html#a617813e5ad89d5c85f9876bdfeb63bc2">WS_OPCODE_PONG</a>);</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="websocket_8c.html#a617813e5ad89d5c85f9876bdfeb63bc2">WS_OPCODE_PONG</a>:</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;            s-&gt;<a class="code" href="struct__sx__st.html#a646289b98b1c4fa392a25bacbba8b7f6">want_read</a> = 1;</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;            <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;unhandled opcode: %x&quot;</span>, frame-&gt;<a class="code" href="struct__libwebsock__frame.html#a7c9b9f8be44f48eb518df18449ab9230">opcode</a>);</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;        }</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;        free(frame-&gt;<a class="code" href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">rawdata</a>);</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;        free(frame);</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;        sc-&gt;frame = NULL;</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        <span class="keywordflow">if</span> (sc-&gt;state == websocket_CLOSING) {</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;            <a class="code" href="sx_8c.html#a2c0702ef72f2dc3adac15b7000499666">_sx_buffer_clear</a>(buf);</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;        }</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;    }</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;passing buffer: %.*s&quot;</span>, sc-&gt;buf_len, sc-&gt;buf);</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    <a class="code" href="sx_8c.html#a8747e3c53d6e80d233532cd03ae342c7">_sx_buffer_set</a>(buf, sc-&gt;buf, sc-&gt;buf_len, NULL);</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    sc-&gt;buf_len = 0;</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;}</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;</div><div class="line"><a name="l00516"></a><span class="lineno"><a class="line" href="websocket_8c.html#a19e43f5f47a68b3525037421ffb18278">  516</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="websocket_8c.html#a19e43f5f47a68b3525037421ffb18278">_sx_websocket_wio</a>(<a class="code" href="struct__sx__st.html">sx_t</a> s, <a class="code" href="struct__sx__plugin__st.html">sx_plugin_t</a> p, <a class="code" href="struct__sx__buf__st.html">sx_buf_t</a> buf) {</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    _sx_websocket_conn_t sc = (_sx_websocket_conn_t) s-&gt;<a class="code" href="struct__sx__st.html#ad08e34d697fd8325ca4cf2c053e6fc83">plugin_data</a>[p-&gt;<a class="code" href="struct__sx__plugin__st.html#abb13fd9b23bee64219e9fb3d0997d669">index</a>];</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;    <span class="comment">/* only bothering if it is active websocket */</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    <span class="keywordflow">if</span>(!(s-&gt;<a class="code" href="struct__sx__st.html#ae36f40642e962113484a05e1b5f9526c">flags</a> &amp; <a class="code" href="plugins_8h.html#a8a4d8720060b21fd5e622ed3f86bd682">SX_WEBSOCKET_WRAPPER</a>))</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;        <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;in _sx_websocket_wio&quot;</span>);</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;    <span class="keywordflow">if</span>(buf-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a> &gt; 0) {</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;        <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;wrapping %d bytes in WebSocket frame&quot;</span>, buf-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a>);</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;        <a class="code" href="struct__sx__buf__st.html">sx_buf_t</a> frame = <a class="code" href="websocket_8c.html#a5cce428dfb6e3ca7fdc97008f3abfc92">libwebsock_fragment_buffer</a>(buf-&gt;<a class="code" href="struct__sx__buf__st.html#a0395b2c36d1383766094d53d8f620081">data</a>, buf-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a>, <a class="code" href="websocket_8c.html#aa4009f6fda907aeaecaaf64ac791b335">WS_FRAGMENT_FIN</a> | <a class="code" href="websocket_8c.html#ab79cf9ef93b2acb36d9c1f7eba78bf9e">WS_OPCODE_TEXT</a>);</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;        <span class="keywordflow">if</span> (frame == NULL) {</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="websocket_8c.html#a5bcdeba671c576ff4f031a49e00a5fee">libwebsock_close_with_reason</a>(s, sc, <a class="code" href="websocket_8c.html#a707985d669a9f6de6738796e6171711d">WS_CLOSE_UNEXPECTED_ERROR</a>, <span class="stringliteral">&quot;Internal server error&quot;</span>);</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;        }</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        <a class="code" href="sx_8c.html#a8747e3c53d6e80d233532cd03ae342c7">_sx_buffer_set</a>(buf, frame-&gt;<a class="code" href="struct__sx__buf__st.html#a0395b2c36d1383766094d53d8f620081">data</a>, frame-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a>, frame-&gt;<a class="code" href="struct__sx__buf__st.html#a0395b2c36d1383766094d53d8f620081">data</a>);</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;        free(frame);</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    }</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;passing %d bytes frame&quot;</span>, buf-&gt;<a class="code" href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">len</a>);</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;}</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;</div><div class="line"><a name="l00539"></a><span class="lineno"><a class="line" href="websocket_8c.html#a1eb419b8df66f656aa59d45b78116094">  539</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="websocket_8c.html#a1eb419b8df66f656aa59d45b78116094">_sx_websocket_new</a>(<a class="code" href="struct__sx__st.html">sx_t</a> s, <a class="code" href="struct__sx__plugin__st.html">sx_plugin_t</a> p) {</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    _sx_websocket_conn_t sc = (_sx_websocket_conn_t) s-&gt;<a class="code" href="struct__sx__st.html#ad08e34d697fd8325ca4cf2c053e6fc83">plugin_data</a>[p-&gt;<a class="code" href="struct__sx__plugin__st.html#abb13fd9b23bee64219e9fb3d0997d669">index</a>];</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    <span class="keywordflow">if</span>(sc != NULL)</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;preparing for HTTP websocket connect for %d&quot;</span>, s-&gt;<a class="code" href="struct__sx__st.html#a8ed30b1bef2eb6daa10b681fff3a7525">tag</a>);</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    sc = (_sx_websocket_conn_t) calloc(1, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> _sx_websocket_conn_st));</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    sc-&gt;state   = websocket_PRE;</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    sc-&gt;p       = <a class="code" href="pool_8h.html#af0878b049cc74f3e6be76892411357d9">pool_new</a>();</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    sc-&gt;field   = <a class="code" href="str_8c.html#a94f1e902c3eb359c45c6f99809579ed3">spool_new</a>(sc-&gt;p);</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    sc-&gt;value   = <a class="code" href="str_8c.html#a94f1e902c3eb359c45c6f99809579ed3">spool_new</a>(sc-&gt;p);</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    sc-&gt;headers = <a class="code" href="xhash_8c.html#aae45886877cf8c23c542324d94577d8a">xhash_new</a>(11);</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    sc-&gt;buf     = malloc(1024);</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    sc-&gt;parser.data = sc;</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    <span class="comment">/* initialize parser */</span></div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;    http_parser_init(&amp;sc-&gt;parser, HTTP_REQUEST);</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;    s-&gt;<a class="code" href="struct__sx__st.html#ad08e34d697fd8325ca4cf2c053e6fc83">plugin_data</a>[p-&gt;<a class="code" href="struct__sx__plugin__st.html#abb13fd9b23bee64219e9fb3d0997d669">index</a>] = (<span class="keywordtype">void</span> *) sc;</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;    <span class="comment">/* bring the plugin online */</span></div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    <a class="code" href="chain_8c.html#a106ec7b61ace1693606970aacdc55059">_sx_chain_io_plugin</a>(s, p);</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;}</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;</div><div class="line"><a name="l00567"></a><span class="lineno"><a class="line" href="websocket_8c.html#ac3a3451c8d9ddd46a1112a49f72567ca">  567</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="websocket_8c.html#ac3a3451c8d9ddd46a1112a49f72567ca">_sx_websocket_free</a>(<a class="code" href="struct__sx__st.html">sx_t</a> s, <a class="code" href="struct__sx__plugin__st.html">sx_plugin_t</a> p) {</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    _sx_websocket_conn_t sc = (_sx_websocket_conn_t) s-&gt;<a class="code" href="struct__sx__st.html#ad08e34d697fd8325ca4cf2c053e6fc83">plugin_data</a>[p-&gt;<a class="code" href="struct__sx__plugin__st.html#abb13fd9b23bee64219e9fb3d0997d669">index</a>];</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    <span class="keywordflow">if</span>(sc == NULL)</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    <a class="code" href="log_8h.html#aa77e596ef13d2f0f75d0ac9540ed358d">log_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;cleaning up websocket state&quot;</span>);</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    <a class="code" href="pool_8c.html#a2130bc8ecc919bb8029e3c83ecc1b7a8">pool_free</a>(sc-&gt;p);</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;    <span class="keywordflow">if</span> (sc-&gt;frame) free(((<a class="code" href="struct__libwebsock__frame.html">libwebsock_frame</a> *)sc-&gt;frame)-&gt;rawdata);</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    free(sc-&gt;frame);</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;    free(sc);</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    s-&gt;<a class="code" href="struct__sx__st.html#ad08e34d697fd8325ca4cf2c053e6fc83">plugin_data</a>[p-&gt;<a class="code" href="struct__sx__plugin__st.html#abb13fd9b23bee64219e9fb3d0997d669">index</a>] = NULL;</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;}</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;</div><div class="line"><a name="l00585"></a><span class="lineno"><a class="line" href="websocket_8c.html#aa6975ae1c73bd8f6094a6fef87b5e4eb">  585</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="websocket_8c.html#aa6975ae1c73bd8f6094a6fef87b5e4eb">sx_websocket_init</a>(<a class="code" href="struct__sx__env__st.html">sx_env_t</a> env, <a class="code" href="struct__sx__plugin__st.html">sx_plugin_t</a> p, va_list args) {</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    <a class="code" href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a>(<a class="code" href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a>, <span class="stringliteral">&quot;initialising websocket plugin&quot;</span>);</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    p-&gt;<a class="code" href="struct__sx__plugin__st.html#a27444d37dbc35954b3f1eba0d20c132a">server</a> = <a class="code" href="websocket_8c.html#a1eb419b8df66f656aa59d45b78116094">_sx_websocket_new</a>;</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    p-&gt;<a class="code" href="struct__sx__plugin__st.html#a3017d9ef744cc00ab7a9a1e200a9bceb">rio</a> = <a class="code" href="websocket_8c.html#a66ae916ea92382085ee2010ae5ec0264">_sx_websocket_rio</a>;</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;    p-&gt;<a class="code" href="struct__sx__plugin__st.html#a76ffe4708b9423b5f9b192e8afd66359">wio</a> = <a class="code" href="websocket_8c.html#a19e43f5f47a68b3525037421ffb18278">_sx_websocket_wio</a>;</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    p-&gt;<a class="code" href="struct__sx__plugin__st.html#a5212e827a070ab7c44a5a14f4ca2bdfa">free</a> = <a class="code" href="websocket_8c.html#ac3a3451c8d9ddd46a1112a49f72567ca">_sx_websocket_free</a>;</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    <span class="keywordtype">char</span> *http_forward = va_arg(args, <span class="keywordtype">char</span>*);</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    p-&gt;<a class="code" href="struct__sx__plugin__st.html#ac60896df809170de2ec96633239a5cbe">private</a> = http_forward;</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;    <a class="code" href="websocket_8c.html#a1dec008fbb156669ec30f7f5f5d10d5c">settings</a>.on_headers_complete = <a class="code" href="websocket_8c.html#a42d3f18934e56d2090af02b32814747e">_sx_websocket_http_headers_complete</a>;</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    <a class="code" href="websocket_8c.html#a1dec008fbb156669ec30f7f5f5d10d5c">settings</a>.on_header_field = <a class="code" href="websocket_8c.html#ab9beee0107e574d60e84cec1fcf41517">_sx_websocket_http_header_field</a>;</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;    <a class="code" href="websocket_8c.html#a1dec008fbb156669ec30f7f5f5d10d5c">settings</a>.on_header_value = <a class="code" href="websocket_8c.html#ac796e1b92b41697bb0c837e1f9586d23">_sx_websocket_http_header_value</a>;</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;}</div><div class="ttc" id="struct__libwebsock__frame_html_a3c93412d517a8e7f693dc824099c80f9"><div class="ttname"><a href="struct__libwebsock__frame.html#a3c93412d517a8e7f693dc824099c80f9">_libwebsock_frame::state</a></div><div class="ttdeci">enum WS_FRAME_STATE state</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00078">websocket.c:78</a></div></div>
<div class="ttc" id="struct__sx__plugin__st_html_a5212e827a070ab7c44a5a14f4ca2bdfa"><div class="ttname"><a href="struct__sx__plugin__st.html#a5212e827a070ab7c44a5a14f4ca2bdfa">_sx_plugin_st::free</a></div><div class="ttdeci">void(* free)(sx_t s, sx_plugin_t p)</div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00357">sx.h:357</a></div></div>
<div class="ttc" id="pool_8c_html_a2130bc8ecc919bb8029e3c83ecc1b7a8"><div class="ttname"><a href="pool_8c.html#a2130bc8ecc919bb8029e3c83ecc1b7a8">pool_free</a></div><div class="ttdeci">void pool_free(pool_t p)</div><div class="ttdef"><b>Definition:</b> <a href="pool_8c_source.html#l00226">pool.c:226</a></div></div>
<div class="ttc" id="struct__sx__buf__st_html"><div class="ttname"><a href="struct__sx__buf__st.html">_sx_buf_st</a></div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00113">sx.h:113</a></div></div>
<div class="ttc" id="websocket_8c_html_aa6f1b74319178f567b26e741dcc92bb7"><div class="ttname"><a href="websocket_8c.html#aa6f1b74319178f567b26e741dcc92bb7">_sx_websocket_http_return</a></div><div class="ttdeci">static void _sx_websocket_http_return(sx_t s, char *status, char *headers_format,...)</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00287">websocket.c:287</a></div></div>
<div class="ttc" id="sx_8h_html_af93b50cc804e6f178556f4d13e5cf136a1be8958474e3b1468f1b772ee1e230bb"><div class="ttname"><a href="sx_8h.html#af93b50cc804e6f178556f4d13e5cf136a1be8958474e3b1468f1b772ee1e230bb">event_WANT_WRITE</a></div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00058">sx.h:58</a></div></div>
<div class="ttc" id="struct__sx__st_html_a62f156e716275786904b1cbb1cb9f924"><div class="ttname"><a href="struct__sx__st.html#a62f156e716275786904b1cbb1cb9f924">_sx_st::state</a></div><div class="ttdeci">_sx_state_t state</div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00319">sx.h:319</a></div></div>
<div class="ttc" id="sx_8h_html_ae0dede2d3e2457a3ab07c0d5ae7fb3eb"><div class="ttname"><a href="sx_8h.html#ae0dede2d3e2457a3ab07c0d5ae7fb3eb">_sx_event</a></div><div class="ttdeci">#define _sx_event(s, e, data)</div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00395">sx.h:395</a></div></div>
<div class="ttc" id="struct__sx__plugin__st_html_a27444d37dbc35954b3f1eba0d20c132a"><div class="ttname"><a href="struct__sx__plugin__st.html#a27444d37dbc35954b3f1eba0d20c132a">_sx_plugin_st::server</a></div><div class="ttdeci">void(* server)(sx_t s, sx_plugin_t p)</div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00360">sx.h:360</a></div></div>
<div class="ttc" id="struct__sx__st_html_ae36f40642e962113484a05e1b5f9526c"><div class="ttname"><a href="struct__sx__st.html#ae36f40642e962113484a05e1b5f9526c">_sx_st::flags</a></div><div class="ttdeci">unsigned int flags</div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00276">sx.h:276</a></div></div>
<div class="ttc" id="websocket_8c_html_a8649f79165247f72f96226af4a5e6248"><div class="ttname"><a href="websocket_8c.html#a8649f79165247f72f96226af4a5e6248">WS_CLOSE_PROTOCOL_ERROR</a></div><div class="ttdeci">#define WS_CLOSE_PROTOCOL_ERROR</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00048">websocket.c:48</a></div></div>
<div class="ttc" id="struct__sx__st_html_ae33e27d3193a61b3d41142ad69d0fe28"><div class="ttname"><a href="struct__sx__st.html#ae33e27d3193a61b3d41142ad69d0fe28">_sx_st::wbufq</a></div><div class="ttdeci">jqueue_t wbufq</div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00301">sx.h:301</a></div></div>
<div class="ttc" id="struct__libwebsock__frame_html_af261f97a025a579bbfc7763b80ac34ac"><div class="ttname"><a href="struct__libwebsock__frame.html#af261f97a025a579bbfc7763b80ac34ac">_libwebsock_frame::mask_offset</a></div><div class="ttdeci">unsigned int mask_offset</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00069">websocket.c:69</a></div></div>
<div class="ttc" id="base64_8c_html_ab6f49f5e1242e04e09c0c99bf069c8f9"><div class="ttname"><a href="base64_8c.html#ab6f49f5e1242e04e09c0c99bf069c8f9">b64_encode</a></div><div class="ttdeci">char * b64_encode(char *buf, int len)</div><div class="ttdef"><b>Definition:</b> <a href="base64_8c_source.html#l00260">base64.c:260</a></div></div>
<div class="ttc" id="sx_8h_html_a8c3a879f7829619d857e579100833159aa8bc955fbaeecdd64b56a50c93ead924"><div class="ttname"><a href="sx_8h.html#a8c3a879f7829619d857e579100833159aa8bc955fbaeecdd64b56a50c93ead924">state_NONE</a></div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00070">sx.h:70</a></div></div>
<div class="ttc" id="struct__sx__env__st_html"><div class="ttname"><a href="struct__sx__env__st.html">_sx_env_st</a></div><div class="ttdoc">an environment </div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00382">sx.h:382</a></div></div>
<div class="ttc" id="struct__sx__st_html_a8ed30b1bef2eb6daa10b681fff3a7525"><div class="ttname"><a href="struct__sx__st.html#a8ed30b1bef2eb6daa10b681fff3a7525">_sx_st::tag</a></div><div class="ttdeci">int tag</div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00258">sx.h:258</a></div></div>
<div class="ttc" id="struct__sx__plugin__st_html"><div class="ttname"><a href="struct__sx__plugin__st.html">_sx_plugin_st</a></div><div class="ttdoc">a plugin </div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00347">sx.h:347</a></div></div>
<div class="ttc" id="struct__libwebsock__frame_html"><div class="ttname"><a href="struct__libwebsock__frame.html">_libwebsock_frame</a></div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00066">websocket.c:66</a></div></div>
<div class="ttc" id="struct__libwebsock__frame_html_afdfddf104855e75ea2da41a741edf129"><div class="ttname"><a href="struct__libwebsock__frame.html#afdfddf104855e75ea2da41a741edf129">_libwebsock_frame::rawdata</a></div><div class="ttdeci">char * rawdata</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00076">websocket.c:76</a></div></div>
<div class="ttc" id="websocket_8c_html_a56b46814d738f7ec55e13eee4d333038"><div class="ttname"><a href="websocket_8c.html#a56b46814d738f7ec55e13eee4d333038">libwebsock_fail_connection</a></div><div class="ttdeci">void libwebsock_fail_connection(sx_t s, _sx_websocket_conn_t sc, unsigned short close_code)</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00235">websocket.c:235</a></div></div>
<div class="ttc" id="str_8c_html_a80e7fd3fffcd8855c1e971fd6b16fbb2"><div class="ttname"><a href="str_8c.html#a80e7fd3fffcd8855c1e971fd6b16fbb2">j_atoi</a></div><div class="ttdeci">int j_atoi(const char *a, int def)</div><div class="ttdef"><b>Definition:</b> <a href="str_8c_source.html#l00087">str.c:87</a></div></div>
<div class="ttc" id="chain_8c_html_a106ec7b61ace1693606970aacdc55059"><div class="ttname"><a href="chain_8c.html#a106ec7b61ace1693606970aacdc55059">_sx_chain_io_plugin</a></div><div class="ttdeci">void _sx_chain_io_plugin(sx_t s, sx_plugin_t p)</div><div class="ttdef"><b>Definition:</b> <a href="chain_8c_source.html#l00025">chain.c:25</a></div></div>
<div class="ttc" id="websocket_8c_html_adb12bc6c3313dd08ad3474f7b1c2b161aa1c3517af307dad09ef38748a0b7a0bd"><div class="ttname"><a href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161aa1c3517af307dad09ef38748a0b7a0bd">sw_start</a></div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00059">websocket.c:59</a></div></div>
<div class="ttc" id="websocket_8c_html_ac796e1b92b41697bb0c837e1f9586d23"><div class="ttname"><a href="websocket_8c.html#ac796e1b92b41697bb0c837e1f9586d23">_sx_websocket_http_header_value</a></div><div class="ttdeci">static int _sx_websocket_http_header_value(http_parser *parser, const char *chars, size_t length)</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00265">websocket.c:265</a></div></div>
<div class="ttc" id="struct__libwebsock__frame_html_a7c9b9f8be44f48eb518df18449ab9230"><div class="ttname"><a href="struct__libwebsock__frame.html#a7c9b9f8be44f48eb518df18449ab9230">_libwebsock_frame::opcode</a></div><div class="ttdeci">unsigned int opcode</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00068">websocket.c:68</a></div></div>
<div class="ttc" id="pool_8h_html_af0878b049cc74f3e6be76892411357d9"><div class="ttname"><a href="pool_8h.html#af0878b049cc74f3e6be76892411357d9">pool_new</a></div><div class="ttdeci">#define pool_new()</div><div class="ttdef"><b>Definition:</b> <a href="pool_8h_source.html#l00097">pool.h:97</a></div></div>
<div class="ttc" id="websocket_8c_html_a1eb419b8df66f656aa59d45b78116094"><div class="ttname"><a href="websocket_8c.html#a1eb419b8df66f656aa59d45b78116094">_sx_websocket_new</a></div><div class="ttdeci">static void _sx_websocket_new(sx_t s, sx_plugin_t p)</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00539">websocket.c:539</a></div></div>
<div class="ttc" id="structsha1__state__s_html"><div class="ttname"><a href="structsha1__state__s.html">sha1_state_s</a></div><div class="ttdef"><b>Definition:</b> <a href="sha1_8h_source.html#l00053">sha1.h:53</a></div></div>
<div class="ttc" id="struct__libwebsock__frame_html_a8b21f5b9f52ff71b90fd7820d824ece5"><div class="ttname"><a href="struct__libwebsock__frame.html#a8b21f5b9f52ff71b90fd7820d824ece5">_libwebsock_frame::payload_len_short</a></div><div class="ttdeci">unsigned int payload_len_short</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00074">websocket.c:74</a></div></div>
<div class="ttc" id="websocket_8c_html_a43b02c8cbb7c3c2873dfab19f5fdca63"><div class="ttname"><a href="websocket_8c.html#a43b02c8cbb7c3c2873dfab19f5fdca63">libwebsock_read_header</a></div><div class="ttdeci">static int libwebsock_read_header(libwebsock_frame *frame)</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00081">websocket.c:81</a></div></div>
<div class="ttc" id="websocket_8c_html_a42d3f18934e56d2090af02b32814747e"><div class="ttname"><a href="websocket_8c.html#a42d3f18934e56d2090af02b32814747e">_sx_websocket_http_headers_complete</a></div><div class="ttdeci">static int _sx_websocket_http_headers_complete(http_parser *parser)</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00277">websocket.c:277</a></div></div>
<div class="ttc" id="websocket_8c_html_ab9beee0107e574d60e84cec1fcf41517"><div class="ttname"><a href="websocket_8c.html#ab9beee0107e574d60e84cec1fcf41517">_sx_websocket_http_header_field</a></div><div class="ttdeci">static int _sx_websocket_http_header_field(http_parser *parser, const char *chars, size_t length)</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00250">websocket.c:250</a></div></div>
<div class="ttc" id="struct__sx__st_html"><div class="ttname"><a href="struct__sx__st.html">_sx_st</a></div><div class="ttdoc">holds the state for a single stream </div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00253">sx.h:253</a></div></div>
<div class="ttc" id="struct__sx__buf__st_html_a0395b2c36d1383766094d53d8f620081"><div class="ttname"><a href="struct__sx__buf__st.html#a0395b2c36d1383766094d53d8f620081">_sx_buf_st::data</a></div><div class="ttdeci">char * data</div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00114">sx.h:114</a></div></div>
<div class="ttc" id="sha1_8c_html_a0ecb75749f90d409425966b4b67bdd02"><div class="ttname"><a href="sha1_8c.html#a0ecb75749f90d409425966b4b67bdd02">sha1_init</a></div><div class="ttdeci">void sha1_init(sha1_state_t *ctx)</div><div class="ttdef"><b>Definition:</b> <a href="sha1_8c_source.html#l00033">sha1.c:33</a></div></div>
<div class="ttc" id="jqueue_8c_html_af4a242120a03da61e6e2129c16cd7d9e"><div class="ttname"><a href="jqueue_8c.html#af4a242120a03da61e6e2129c16cd7d9e">jqueue_push</a></div><div class="ttdeci">void jqueue_push(jqueue_t q, void *data, int priority)</div><div class="ttdef"><b>Definition:</b> <a href="jqueue_8c_source.html#l00044">jqueue.c:44</a></div></div>
<div class="ttc" id="websocket_8c_html_adb12bc6c3313dd08ad3474f7b1c2b161a317cb3780146cb13b900d0c527f059dd"><div class="ttname"><a href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161a317cb3780146cb13b900d0c527f059dd">sw_got_full_len</a></div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00062">websocket.c:62</a></div></div>
<div class="ttc" id="xhash_8c_html_a77c7505e6946724017451e82203b4b10"><div class="ttname"><a href="xhash_8c.html#a77c7505e6946724017451e82203b4b10">xhash_put</a></div><div class="ttdeci">void xhash_put(xht h, const char *key, void *val)</div><div class="ttdef"><b>Definition:</b> <a href="xhash_8c_source.html#l00163">xhash.c:163</a></div></div>
<div class="ttc" id="str_8c_html_a8af3044d47157eae581b8e4d994a0946"><div class="ttname"><a href="str_8c.html#a8af3044d47157eae581b8e4d994a0946">strunescape</a></div><div class="ttdeci">char * strunescape(pool_t p, char *buf)</div><div class="ttdef"><b>Definition:</b> <a href="str_8c_source.html#l00238">str.c:238</a></div></div>
<div class="ttc" id="struct__libwebsock__frame_html_a930396080253aad12478fa97c91a9a38"><div class="ttname"><a href="struct__libwebsock__frame.html#a930396080253aad12478fa97c91a9a38">_libwebsock_frame::rawdata_idx</a></div><div class="ttdeci">unsigned int rawdata_idx</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00071">websocket.c:71</a></div></div>
<div class="ttc" id="sx_8c_html_ae9fe86d2c7082e26fc310f7dc69a1a59"><div class="ttname"><a href="sx_8c.html#ae9fe86d2c7082e26fc310f7dc69a1a59">_sx_buffer_new</a></div><div class="ttdeci">sx_buf_t _sx_buffer_new(const char *data, int len, _sx_notify_t notify, void *notify_arg)</div><div class="ttdoc">utility: make a new buffer if len&gt;0 but data is NULL, the buffer will contain that many bytes of garb...</div><div class="ttdef"><b>Definition:</b> <a href="sx_8c_source.html#l00220">sx.c:220</a></div></div>
<div class="ttc" id="websocket_8c_html_a786da3147cef7625cd87f66b3732e13d"><div class="ttname"><a href="websocket_8c.html#a786da3147cef7625cd87f66b3732e13d">WS_OPCODE_CONTINUE</a></div><div class="ttdeci">#define WS_OPCODE_CONTINUE</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00037">websocket.c:37</a></div></div>
<div class="ttc" id="websocket_8c_html_a62348e89671e29e78749942417b760cb"><div class="ttname"><a href="websocket_8c.html#a62348e89671e29e78749942417b760cb">WS_CLOSE_NORMAL</a></div><div class="ttdeci">#define WS_CLOSE_NORMAL</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00046">websocket.c:46</a></div></div>
<div class="ttc" id="str_8c_html_a4e885bef2a6c68e02ba64bf56b608117"><div class="ttname"><a href="str_8c.html#a4e885bef2a6c68e02ba64bf56b608117">j_strcmp</a></div><div class="ttdeci">int j_strcmp(const char *a, const char *b)</div><div class="ttdef"><b>Definition:</b> <a href="str_8c_source.html#l00043">str.c:43</a></div></div>
<div class="ttc" id="websocket_8c_html_a153f2c6408b34142e2056dbf7e1fc7e0"><div class="ttname"><a href="websocket_8c.html#a153f2c6408b34142e2056dbf7e1fc7e0">WS_OPCODE_CLOSE</a></div><div class="ttdeci">#define WS_OPCODE_CLOSE</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00040">websocket.c:40</a></div></div>
<div class="ttc" id="io_8c_html_af7cab32176ea2dd80efad4a47ac2463c"><div class="ttname"><a href="io_8c.html#af7cab32176ea2dd80efad4a47ac2463c">sx_close</a></div><div class="ttdeci">void sx_close(sx_t s)</div><div class="ttdef"><b>Definition:</b> <a href="io_8c_source.html#l00512">io.c:512</a></div></div>
<div class="ttc" id="sha1_8c_html_a03ed5cd4c7e08af365b30f07947c2ef9"><div class="ttname"><a href="sha1_8c.html#a03ed5cd4c7e08af365b30f07947c2ef9">sha1_finish</a></div><div class="ttdeci">void sha1_finish(sha1_state_t *ctx, unsigned char hashout[20])</div><div class="ttdef"><b>Definition:</b> <a href="sha1_8c_source.html#l00070">sha1.c:70</a></div></div>
<div class="ttc" id="log_8h_html_aa77e596ef13d2f0f75d0ac9540ed358d"><div class="ttname"><a href="log_8h.html#aa77e596ef13d2f0f75d0ac9540ed358d">log_debug</a></div><div class="ttdeci">#define log_debug(...)</div><div class="ttdef"><b>Definition:</b> <a href="log_8h_source.html#l00065">log.h:65</a></div></div>
<div class="ttc" id="str_8c_html_a2b04e422b6cb464e160569c2d242058b"><div class="ttname"><a href="str_8c.html#a2b04e422b6cb464e160569c2d242058b">spool_print</a></div><div class="ttdeci">const char * spool_print(spool s)</div><div class="ttdef"><b>Definition:</b> <a href="str_8c_source.html#l00186">str.c:186</a></div></div>
<div class="ttc" id="plugins_8h_html_a8a4d8720060b21fd5e622ed3f86bd682"><div class="ttname"><a href="plugins_8h.html#a8a4d8720060b21fd5e622ed3f86bd682">SX_WEBSOCKET_WRAPPER</a></div><div class="ttdeci">#define SX_WEBSOCKET_WRAPPER</div><div class="ttdef"><b>Definition:</b> <a href="plugins_8h_source.html#l00034">plugins.h:34</a></div></div>
<div class="ttc" id="sx_8h_html_ab21d9b35f3d1d47ac158051ef37a8d64"><div class="ttname"><a href="sx_8h.html#ab21d9b35f3d1d47ac158051ef37a8d64">_sx_debug</a></div><div class="ttdeci">#define _sx_debug</div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00408">sx.h:408</a></div></div>
<div class="ttc" id="websocket_8c_html_adb12bc6c3313dd08ad3474f7b1c2b161"><div class="ttname"><a href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161">WS_FRAME_STATE</a></div><div class="ttdeci">WS_FRAME_STATE</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00058">websocket.c:58</a></div></div>
<div class="ttc" id="error_8c_html_a2c3a7964ac068e37fc03d3a8dd5ccc19"><div class="ttname"><a href="error_8c.html#a2c3a7964ac068e37fc03d3a8dd5ccc19">sx_error</a></div><div class="ttdeci">void sx_error(sx_t s, int err, const char *text)</div><div class="ttdef"><b>Definition:</b> <a href="error_8c_source.html#l00094">error.c:94</a></div></div>
<div class="ttc" id="websocket_8c_html_a5bcdeba671c576ff4f031a49e00a5fee"><div class="ttname"><a href="websocket_8c.html#a5bcdeba671c576ff4f031a49e00a5fee">libwebsock_close_with_reason</a></div><div class="ttdeci">int libwebsock_close_with_reason(sx_t s, _sx_websocket_conn_t sc, unsigned short code, const char *reason)</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00211">websocket.c:211</a></div></div>
<div class="ttc" id="websocket_8c_html_aa09f60de81444ec03fbdc5d01648165e"><div class="ttname"><a href="websocket_8c.html#aa09f60de81444ec03fbdc5d01648165e">FRAME_CHUNK_LENGTH</a></div><div class="ttdeci">#define FRAME_CHUNK_LENGTH</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00035">websocket.c:35</a></div></div>
<div class="ttc" id="websocket_8c_html_adb12bc6c3313dd08ad3474f7b1c2b161a1de5a2cbe3da7ae5869e4cfde15500b1"><div class="ttname"><a href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161a1de5a2cbe3da7ae5869e4cfde15500b1">sw_loaded_mask</a></div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00063">websocket.c:63</a></div></div>
<div class="ttc" id="struct__libwebsock__frame_html_aa9f2fbda1084ffe2865530dbd276e423"><div class="ttname"><a href="struct__libwebsock__frame.html#aa9f2fbda1084ffe2865530dbd276e423">_libwebsock_frame::payload_offset</a></div><div class="ttdeci">unsigned int payload_offset</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00070">websocket.c:70</a></div></div>
<div class="ttc" id="websocket_8c_html_af04d3f2e84f54f8e97aeeba5c4e5974c"><div class="ttname"><a href="websocket_8c.html#af04d3f2e84f54f8e97aeeba5c4e5974c">libwebsock_frame</a></div><div class="ttdeci">struct _libwebsock_frame libwebsock_frame</div></div>
<div class="ttc" id="struct__libwebsock__frame_html_a42efff1f67cb6fa8d75b711d5c8a54f9"><div class="ttname"><a href="struct__libwebsock__frame.html#a42efff1f67cb6fa8d75b711d5c8a54f9">_libwebsock_frame::mask</a></div><div class="ttdeci">unsigned char mask[4]</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00077">websocket.c:77</a></div></div>
<div class="ttc" id="websocket_8c_html_a1dec008fbb156669ec30f7f5f5d10d5c"><div class="ttname"><a href="websocket_8c.html#a1dec008fbb156669ec30f7f5f5d10d5c">settings</a></div><div class="ttdeci">static http_parser_settings settings</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00031">websocket.c:31</a></div></div>
<div class="ttc" id="websocket_8c_html_a8a1eca64e868e62160a625250c61398d"><div class="ttname"><a href="websocket_8c.html#a8a1eca64e868e62160a625250c61398d">libwebsock_close</a></div><div class="ttdeci">int libwebsock_close(sx_t s, _sx_websocket_conn_t sc)</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00230">websocket.c:230</a></div></div>
<div class="ttc" id="websocket_8c_html_a66ae916ea92382085ee2010ae5ec0264"><div class="ttname"><a href="websocket_8c.html#a66ae916ea92382085ee2010ae5ec0264">_sx_websocket_rio</a></div><div class="ttdeci">static int _sx_websocket_rio(sx_t s, sx_plugin_t p, sx_buf_t buf)</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00314">websocket.c:314</a></div></div>
<div class="ttc" id="websocket_8c_html_aa6975ae1c73bd8f6094a6fef87b5e4eb"><div class="ttname"><a href="websocket_8c.html#aa6975ae1c73bd8f6094a6fef87b5e4eb">sx_websocket_init</a></div><div class="ttdeci">int sx_websocket_init(sx_env_t env, sx_plugin_t p, va_list args)</div><div class="ttdoc">args: none </div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00585">websocket.c:585</a></div></div>
<div class="ttc" id="struct__sx__buf__st_html_a12cad128349bd5ebebe00a360a30083e"><div class="ttname"><a href="struct__sx__buf__st.html#a12cad128349bd5ebebe00a360a30083e">_sx_buf_st::len</a></div><div class="ttdeci">unsigned int len</div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00115">sx.h:115</a></div></div>
<div class="ttc" id="struct__sx__plugin__st_html_ac60896df809170de2ec96633239a5cbe"><div class="ttname"><a href="struct__sx__plugin__st.html#ac60896df809170de2ec96633239a5cbe">_sx_plugin_st::private</a></div><div class="ttdeci">void * private</div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00354">sx.h:354</a></div></div>
<div class="ttc" id="struct__sx__plugin__st_html_a76ffe4708b9423b5f9b192e8afd66359"><div class="ttname"><a href="struct__sx__plugin__st.html#a76ffe4708b9423b5f9b192e8afd66359">_sx_plugin_st::wio</a></div><div class="ttdeci">int(* wio)(sx_t s, sx_plugin_t p, sx_buf_t buf)</div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00363">sx.h:363</a></div></div>
<div class="ttc" id="websocket_8c_html_a5cce428dfb6e3ca7fdc97008f3abfc92"><div class="ttname"><a href="websocket_8c.html#a5cce428dfb6e3ca7fdc97008f3abfc92">libwebsock_fragment_buffer</a></div><div class="ttdeci">sx_buf_t libwebsock_fragment_buffer(const char *data, unsigned int len, int flags)</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00153">websocket.c:153</a></div></div>
<div class="ttc" id="sx_8c_html_a2c0702ef72f2dc3adac15b7000499666"><div class="ttname"><a href="sx_8c.html#a2c0702ef72f2dc3adac15b7000499666">_sx_buffer_clear</a></div><div class="ttdeci">void _sx_buffer_clear(sx_buf_t buf)</div><div class="ttdoc">utility: clear out a buffer, but don&amp;#39;t deallocate it </div><div class="ttdef"><b>Definition:</b> <a href="sx_8c_source.html#l00252">sx.c:252</a></div></div>
<div class="ttc" id="struct__libwebsock__frame_html_ab4a2db10d34e1bb1c5d527d41707c15e"><div class="ttname"><a href="struct__libwebsock__frame.html#ab4a2db10d34e1bb1c5d527d41707c15e">_libwebsock_frame::rawdata_sz</a></div><div class="ttdeci">unsigned int rawdata_sz</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00072">websocket.c:72</a></div></div>
<div class="ttc" id="websocket_8c_html_a707985d669a9f6de6738796e6171711d"><div class="ttname"><a href="websocket_8c.html#a707985d669a9f6de6738796e6171711d">WS_CLOSE_UNEXPECTED_ERROR</a></div><div class="ttdeci">#define WS_CLOSE_UNEXPECTED_ERROR</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00056">websocket.c:56</a></div></div>
<div class="ttc" id="sha1_8c_html_aad1a273b8ec785f76966a28700fe275e"><div class="ttname"><a href="sha1_8c.html#aad1a273b8ec785f76966a28700fe275e">sha1_append</a></div><div class="ttdeci">void sha1_append(sha1_state_t *ctx, const unsigned char *dataIn, int len)</div><div class="ttdef"><b>Definition:</b> <a href="sha1_8c_source.html#l00052">sha1.c:52</a></div></div>
<div class="ttc" id="websocket_8c_html_ab79cf9ef93b2acb36d9c1f7eba78bf9e"><div class="ttname"><a href="websocket_8c.html#ab79cf9ef93b2acb36d9c1f7eba78bf9e">WS_OPCODE_TEXT</a></div><div class="ttdeci">#define WS_OPCODE_TEXT</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00038">websocket.c:38</a></div></div>
<div class="ttc" id="websocket_8c_html_a19e43f5f47a68b3525037421ffb18278"><div class="ttname"><a href="websocket_8c.html#a19e43f5f47a68b3525037421ffb18278">_sx_websocket_wio</a></div><div class="ttdeci">static int _sx_websocket_wio(sx_t s, sx_plugin_t p, sx_buf_t buf)</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00516">websocket.c:516</a></div></div>
<div class="ttc" id="struct__libwebsock__frame_html_a110aa0f18e71d8432a5e0d30c9966429"><div class="ttname"><a href="struct__libwebsock__frame.html#a110aa0f18e71d8432a5e0d30c9966429">_libwebsock_frame::payload_len</a></div><div class="ttdeci">unsigned int payload_len</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00075">websocket.c:75</a></div></div>
<div class="ttc" id="websocket_8c_html_a8bc922773b09612cb9e922be3a7ea458"><div class="ttname"><a href="websocket_8c.html#a8bc922773b09612cb9e922be3a7ea458">libwebsock_send_fragment</a></div><div class="ttdeci">int libwebsock_send_fragment(sx_t s, _sx_websocket_conn_t sc, const char *data, unsigned int len, int flags)</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00201">websocket.c:201</a></div></div>
<div class="ttc" id="websocket_8c_html_ac3a3451c8d9ddd46a1112a49f72567ca"><div class="ttname"><a href="websocket_8c.html#ac3a3451c8d9ddd46a1112a49f72567ca">_sx_websocket_free</a></div><div class="ttdeci">static void _sx_websocket_free(sx_t s, sx_plugin_t p)</div><div class="ttdoc">cleanup </div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00567">websocket.c:567</a></div></div>
<div class="ttc" id="sx_8h_html_a1df8a93376eda4886470ed664d64ecb5"><div class="ttname"><a href="sx_8h.html#a1df8a93376eda4886470ed664d64ecb5">stream_err_BAD_FORMAT</a></div><div class="ttdeci">#define stream_err_BAD_FORMAT</div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00124">sx.h:124</a></div></div>
<div class="ttc" id="xhash_8c_html_aae269253cc83fcee6883f6097dcb714f"><div class="ttname"><a href="xhash_8c.html#aae269253cc83fcee6883f6097dcb714f">xhash_get</a></div><div class="ttdeci">void * xhash_get(xht h, const char *key)</div><div class="ttdef"><b>Definition:</b> <a href="xhash_8c_source.html#l00184">xhash.c:184</a></div></div>
<div class="ttc" id="struct__libwebsock__frame_html_a6f851cc81f0dca146bd01138bd21c79b"><div class="ttname"><a href="struct__libwebsock__frame.html#a6f851cc81f0dca146bd01138bd21c79b">_libwebsock_frame::size</a></div><div class="ttdeci">unsigned int size</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00073">websocket.c:73</a></div></div>
<div class="ttc" id="websocket_8c_html_a4575845967f3087a26ffa7f13cbed566"><div class="ttname"><a href="websocket_8c.html#a4575845967f3087a26ffa7f13cbed566">websocket_guid</a></div><div class="ttdeci">static const char websocket_guid[]</div><div class="ttdoc">this plugin implements WebSocket C2S access RFC 7395 : An Extensible Messaging and Presence Protocol ...</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00029">websocket.c:29</a></div></div>
<div class="ttc" id="mio__impl_8h_html_aac8c2f9eb72a5e1700a8f67eab0ecd53"><div class="ttname"><a href="mio__impl_8h.html#aac8c2f9eb72a5e1700a8f67eab0ecd53">ZONE</a></div><div class="ttdeci">#define ZONE</div><div class="ttdef"><b>Definition:</b> <a href="mio__impl_8h_source.html#l00076">mio_impl.h:76</a></div></div>
<div class="ttc" id="struct__sx__st_html_a646289b98b1c4fa392a25bacbba8b7f6"><div class="ttname"><a href="struct__sx__st.html#a646289b98b1c4fa392a25bacbba8b7f6">_sx_st::want_read</a></div><div class="ttdeci">int want_read</div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00306">sx.h:306</a></div></div>
<div class="ttc" id="sx_8c_html_a8747e3c53d6e80d233532cd03ae342c7"><div class="ttname"><a href="sx_8c.html#a8747e3c53d6e80d233532cd03ae342c7">_sx_buffer_set</a></div><div class="ttdeci">void _sx_buffer_set(sx_buf_t buf, char *newdata, int newlength, char *newheap)</div><div class="ttdoc">utility: reset a sx_buf_t&amp;#39;s contents. </div><div class="ttdef"><b>Definition:</b> <a href="sx_8c_source.html#l00299">sx.c:299</a></div></div>
<div class="ttc" id="struct__sx__plugin__st_html_a3017d9ef744cc00ab7a9a1e200a9bceb"><div class="ttname"><a href="struct__sx__plugin__st.html#a3017d9ef744cc00ab7a9a1e200a9bceb">_sx_plugin_st::rio</a></div><div class="ttdeci">int(* rio)(sx_t s, sx_plugin_t p, sx_buf_t buf)</div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00364">sx.h:364</a></div></div>
<div class="ttc" id="xhash_8c_html_aae45886877cf8c23c542324d94577d8a"><div class="ttname"><a href="xhash_8c.html#aae45886877cf8c23c542324d94577d8a">xhash_new</a></div><div class="ttdeci">xht xhash_new(int prime)</div><div class="ttdef"><b>Definition:</b> <a href="xhash_8c_source.html#l00096">xhash.c:96</a></div></div>
<div class="ttc" id="str_8c_html_afcf3496e637edcfe44e88b517fe18333"><div class="ttname"><a href="str_8c.html#afcf3496e637edcfe44e88b517fe18333">j_strlen</a></div><div class="ttdeci">int j_strlen(const char *a)</div><div class="ttdef"><b>Definition:</b> <a href="str_8c_source.html#l00079">str.c:79</a></div></div>
<div class="ttc" id="str_8c_html_aaef2515949ac1b1ba24d28c3c5f059c4"><div class="ttname"><a href="str_8c.html#aaef2515949ac1b1ba24d28c3c5f059c4">spool_escape</a></div><div class="ttdeci">void spool_escape(spool s, const char *raw, int len)</div><div class="ttdef"><b>Definition:</b> <a href="str_8c_source.html#l00155">str.c:155</a></div></div>
<div class="ttc" id="websocket_8c_html_adb12bc6c3313dd08ad3474f7b1c2b161a5a9b32213a7f87f70f25e92d1c37e585"><div class="ttname"><a href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161a5a9b32213a7f87f70f25e92d1c37e585">sw_got_short_len</a></div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00061">websocket.c:61</a></div></div>
<div class="ttc" id="struct__sx__plugin__st_html_abb13fd9b23bee64219e9fb3d0997d669"><div class="ttname"><a href="struct__sx__plugin__st.html#abb13fd9b23bee64219e9fb3d0997d669">_sx_plugin_st::index</a></div><div class="ttdeci">int index</div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00352">sx.h:352</a></div></div>
<div class="ttc" id="websocket_8c_html_a617813e5ad89d5c85f9876bdfeb63bc2"><div class="ttname"><a href="websocket_8c.html#a617813e5ad89d5c85f9876bdfeb63bc2">WS_OPCODE_PONG</a></div><div class="ttdeci">#define WS_OPCODE_PONG</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00042">websocket.c:42</a></div></div>
<div class="ttc" id="struct__libwebsock__frame_html_a4fdefcd48485e29baeb96c130ced4ad0"><div class="ttname"><a href="struct__libwebsock__frame.html#a4fdefcd48485e29baeb96c130ced4ad0">_libwebsock_frame::fin</a></div><div class="ttdeci">unsigned int fin</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00067">websocket.c:67</a></div></div>
<div class="ttc" id="struct__sx__st_html_a4c61463373b07d1ca88a42c14a5ab7d4"><div class="ttname"><a href="struct__sx__st.html#a4c61463373b07d1ca88a42c14a5ab7d4">_sx_st::want_write</a></div><div class="ttdeci">int want_write</div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00306">sx.h:306</a></div></div>
<div class="ttc" id="str_8c_html_a94f1e902c3eb359c45c6f99809579ed3"><div class="ttname"><a href="str_8c.html#a94f1e902c3eb359c45c6f99809579ed3">spool_new</a></div><div class="ttdeci">spool spool_new(pool_t p)</div><div class="ttdef"><b>Definition:</b> <a href="str_8c_source.html#l00119">str.c:119</a></div></div>
<div class="ttc" id="websocket_8c_html_aa4009f6fda907aeaecaaf64ac791b335"><div class="ttname"><a href="websocket_8c.html#aa4009f6fda907aeaecaaf64ac791b335">WS_FRAGMENT_FIN</a></div><div class="ttdeci">#define WS_FRAGMENT_FIN</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00044">websocket.c:44</a></div></div>
<div class="ttc" id="sx_8h_html"><div class="ttname"><a href="sx_8h.html">sx.h</a></div></div>
<div class="ttc" id="websocket_8c_html_a2bb01dad9861d977f2516e67adbdff44"><div class="ttname"><a href="websocket_8c.html#a2bb01dad9861d977f2516e67adbdff44">WS_OPCODE_PING</a></div><div class="ttdeci">#define WS_OPCODE_PING</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00041">websocket.c:41</a></div></div>
<div class="ttc" id="struct__sx__st_html_ad08e34d697fd8325ca4cf2c053e6fc83"><div class="ttname"><a href="struct__sx__st.html#ad08e34d697fd8325ca4cf2c053e6fc83">_sx_st::plugin_data</a></div><div class="ttdeci">void ** plugin_data</div><div class="ttdef"><b>Definition:</b> <a href="sx_8h_source.html#l00330">sx.h:330</a></div></div>
<div class="ttc" id="websocket_8c_html_aed370c3a802dfb53f81fc0bfbc2c5641"><div class="ttname"><a href="websocket_8c.html#aed370c3a802dfb53f81fc0bfbc2c5641">MASK_LENGTH</a></div><div class="ttdeci">#define MASK_LENGTH</div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00034">websocket.c:34</a></div></div>
<div class="ttc" id="websocket_8c_html_adb12bc6c3313dd08ad3474f7b1c2b161ace503a9e705f438452f71bc827b85f7b"><div class="ttname"><a href="websocket_8c.html#adb12bc6c3313dd08ad3474f7b1c2b161ace503a9e705f438452f71bc827b85f7b">sw_got_two</a></div><div class="ttdef"><b>Definition:</b> <a href="websocket_8c_source.html#l00060">websocket.c:60</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
